<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz DWWM Interactif</title>
  <style>
    :root { 
      --color-bg-start: #667eea; 
      --color-bg-end: #764ba2; 
      --color-primary: #74b9ff; 
      --color-success: #00b894; 
      --color-error: #e17055; 
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Segoe UI', sans-serif; 
      background: linear-gradient(135deg, var(--color-bg-start), var(--color-bg-end)); 
      min-height: 100vh; 
      padding: 20px; 
      color: white;
    }
    
    .container { 
      max-width: 800px; 
      margin: auto; 
      background: rgba(255,255,255,0.1); 
      border-radius: 20px; 
      padding: 30px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      text-align: center;
    }
    
    h1 { 
      font-size: 2.5em; 
      margin-bottom: 20px; 
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .mode-selector {
      margin: 30px 0;
    }
    
    .mode-btn {
      display: inline-block;
      margin: 10px;
      padding: 20px 30px;
      background: linear-gradient(135deg, var(--color-primary), #0984e3);
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.3s;
      text-decoration: none;
      min-width: 200px;
    }
    
    .mode-btn:hover { 
      transform: translateY(-5px); 
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }
    
    .mode-btn:disabled {
      background: #999;
      cursor: not-allowed;
      transform: none;
    }
    
    .game-area {
      background: rgba(255,255,255,0.2);
      border-radius: 15px;
      padding: 25px;
      margin: 20px 0;
      min-height: 400px;
      display: none;
    }
    
    .question-card {
      background: rgba(255,255,255,0.9);
      color: #333;
      border-radius: 15px;
      padding: 25px;
      margin: 15px 0;
      text-align: left;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .question-title {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    
    .choice {
      display: block;
      margin: 12px 0;
      padding: 15px;
      background: #f8f9fa;
      border: 2px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .choice:hover {
      background: #e3f2fd;
      border-color: var(--color-primary);
      transform: translateX(5px);
    }
    
    .choice.selected {
      background: #bbdefb;
      border-color: var(--color-primary);
    }
    
    .choice.correct {
      background: #c8e6c9 !important;
      border-color: var(--color-success) !important;
      color: #2e7d32;
    }
    
    .choice.incorrect {
      background: #ffcdd2 !important;
      border-color: var(--color-error) !important;
      color: #c62828;
    }
    
    button {
      background: linear-gradient(135deg, var(--color-primary), #0984e3);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      margin: 10px;
      transition: transform 0.2s;
    }
    
    button:hover { transform: translateY(-3px); }
    button:disabled { 
      background: #999; 
      cursor: not-allowed; 
      transform: none; 
    }
    
    .score-display {
      font-size: 1.3em;
      margin: 20px 0;
      padding: 15px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
    }
    
    .progress-bar {
      background: rgba(255,255,255,0.3);
      border-radius: 10px;
      height: 8px;
      margin: 15px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      background: linear-gradient(90deg, #00d2ff, #3a7bd5);
      height: 100%;
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 10px;
    }
    
    .final-results {
      background: linear-gradient(135deg, #ff9a9e, #fad0c4);
      color: #333;
      border-radius: 15px;
      padding: 30px;
      margin: 20px 0;
    }
    
    .intro-text {
      font-size: 1.1em;
      line-height: 1.6;
      margin: 20px 0;
      opacity: 0.9;
    }
    
    .feature-list {
      text-align: left;
      display: inline-block;
      margin: 20px 0;
    }
    
    .feature-list li {
      margin: 8px 0;
      padding-left: 10px;
    }
    
    .timer {
      font-size: 1.5em;
      font-weight: bold;
      color: #FFD700;
      margin: 10px 0;
    }
    
    .connection-info {
      background: rgba(255,255,255,0.15);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      font-size: 0.9em;
    }
    
    .qr-code {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin: 20px auto;
      display: inline-block;
    }
    
    .players-list {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
    }
    
    .player-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      margin: 5px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }
    
    .status-indicator {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: bold;
    }
    
    .status-connected { background: #28a745; color: white; }
    .status-waiting { background: #ffc107; color: #333; }
    .status-answered { background: #17a2b8; color: white; }
    
    .firebase-setup {
      background: rgba(255,255,255,0.9);
      color: #333;
      border-radius: 15px;
      padding: 25px;
      margin: 20px 0;
      text-align: left;
    }
    
    .firebase-setup code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
    }
    
    .firebase-setup pre {
      background: #f4f4f4;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 10px 0;
    }
    
    .offline-notice {
      background: rgba(255, 193, 7, 0.2);
      border: 2px solid #ffc107;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      color: #856404;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ Quiz DWWM Interactif</h1>
    
    <!-- Configuration Firebase -->
    <div class="firebase-setup" id="firebaseSetup" style="display:none;">
      <h3>üîß Configuration Firebase requise</h3>
      <p>Pour activer le mode multijoueur, configurez Firebase :</p>
      
      <ol style="margin: 15px 0;">
        <li>Allez sur <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a></li>
        <li>Cr√©ez un nouveau projet ou utilisez un existant</li>
        <li>Activez "Realtime Database" avec les r√®gles de test</li>
        <li>Copiez la configuration et remplacez les valeurs ci-dessous</li>
      </ol>
      
      <pre><code>// Remplacez ces valeurs dans le script
const firebaseConfig = {
  apiKey: "demo-api-key",
  authDomain: "demo-project.firebaseapp.com",
  databaseURL: "https://demo-project-default-rtdb.firebaseio.com/",
  projectId: "demo-project" 
};</code></pre>
      
      <button onclick="document.getElementById('firebaseSetup').style.display='none'">‚úÖ J'ai configur√© Firebase</button>
    </div>
    
    <!-- Menu principal -->
    <div id="mainMenu">
      <div class="intro-text">
        <strong>üöÄ Quiz professionnel pour la formation DWWM</strong><br>
        Testez vos connaissances en d√©veloppement web !
      </div>
      
      <div class="offline-notice" id="offlineNotice" style="display:none;">
        ‚ö†Ô∏è Mode multijoueur indisponible (Firebase non configur√©). Le mode solo fonctionne normalement.
      </div>
      
      <div class="feature-list">
        <ul>
          <li>‚úÖ <strong>Mode Solo</strong> - Entra√Ænement personnel</li>
          <li>üéÆ <strong>Mode Multijoueur</strong> - Synchronisation temps r√©el</li>
          <li>‚ö° <strong>Questions m√©lang√©es</strong> - Jamais le m√™me quiz</li>
          <li>üèÜ <strong>Scores et classements</strong> - Comp√©tition amicale</li>
          <li>üì± <strong>Mobile-friendly</strong> - Fonctionne partout</li>
        </ul>
      </div>
      
      <div class="mode-selector">
        <button class="mode-btn" onclick="startSoloMode()">
          ‚ö° Mode Solo<br>
          <small>Test rapide individuel</small>
        </button>
        
        <button class="mode-btn" id="hostBtn" onclick="startHostMode()">
          üñ•Ô∏è Mode H√¥te<br>
          <small>Cr√©er une partie multijoueur</small>
        </button>
        
        <button class="mode-btn" id="joinBtn" onclick="showJoinInterface()">
          üì± Rejoindre<br>
          <small>Participer √† une partie</small>
        </button>
      </div>
    </div>
    
    <!-- Zone de jeu -->
    <div class="game-area" id="gameArea">
      <div class="score-display" id="scoreDisplay"></div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="timer" id="timer"></div>
      <div id="questionContainer"></div>
    </div>
    
    <!-- Section multijoueur -->
    <div class="connection-info" id="connectionInfo" style="display:none;">
      <div id="roomCode"></div>
      <div class="qr-code" id="qrCode" style="display:none;"></div>
      <div id="playersList"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ‚ö†Ô∏è CONFIGURATION FIREBASE - REMPLACEZ PAR VOS VRAIES VALEURS
    const firebaseConfig = {
      apiKey: "AIzaSyCOegG19Z-G04jRXBA3aXUSLTrHrPtEwbQ",
      authDomain: "quiz-4321f.firebaseapp.com",
      databaseURL: "https://quiz-4321f-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "quiz-4321f",
    };

    // Variables globales
    let firebaseEnabled = false;
    let database = null;
    let currentMode = '';
    let currentQuestionIndex = 0;
    let score = 0;
    let questions = [];
    let selectedChoices = [];
    let hasAnswered = false;
    let timeLeft = 30;
    let timer = null;
    let roomCode = '';
    let playerName = '';
    let roomRef = null;
    let playersRef = null;

    // Questions DWWM
    const questionsBySubject = [
      {
        title: "Quel langage est principalement utilis√© pour le d√©veloppement web c√¥t√© client ?",
        choices: ["PHP", "JavaScript", "Python", "Java"],
        answer: [1]
      },
      {
        title: "Quels sont les piliers du d√©veloppement web moderne ?",
        choices: ["HTML", "CSS", "JavaScript", "Flash"],
        answer: [0, 1, 2]
      },
      {
        title: "Que signifie CSS ?",
        choices: ["Computer Style Sheets", "Cascading Style Sheets", "Creative Style Sheets", "Colorful Style Sheets"],
        answer: [1]
      },
      {
        title: "Quels frameworks JavaScript sont populaires ?",
        choices: ["React", "Vue.js", "Angular", "jQuery"],
        answer: [0, 1, 2]
      },
      {
        title: "Quel protocole est utilis√© pour les communications web s√©curis√©es ?",
        choices: ["HTTP", "HTTPS", "FTP", "SSH"],
        answer: [1]
      },
      {
        title: "Que signifie HTML ?",
        choices: ["Hypertext Markup Language", "High Tech Modern Language", "Home Tool Markup Language", "Hypertext Machine Language"],
        answer: [0]
      },
      {
        title: "Quels sont les types de donn√©es primitifs en JavaScript ?",
        choices: ["string", "number", "boolean", "object"],
        answer: [0, 1, 2]
      },
      {
        title: "Quel est le r√¥le principal d'un d√©veloppeur web ?",
        choices: ["Cr√©er des sites web", "R√©parer des ordinateurs", "Installer des logiciels", "G√©rer des r√©seaux"],
        answer: [0]
      },
      {
        title: "Quels outils sont essentiels pour un d√©veloppeur web ?",
        choices: ["√âditeur de code", "Navigateur", "Serveur local", "Calculatrice"],
        answer: [0, 1, 2]
      },
      {
        title: "Que permet de faire PHP ?",
        choices: ["D√©veloppement c√¥t√© serveur", "Stylisation des pages", "Animation des √©l√©ments", "Gestion de base de donn√©es"],
        answer: [0, 3]
      }
    ];
    
    // √âl√©ments DOM
    const mainMenu = document.getElementById('mainMenu');
    const gameArea = document.getElementById('gameArea');
    const questionContainer = document.getElementById('questionContainer');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const progressFill = document.getElementById('progressFill');
    const timerDisplay = document.getElementById('timer');
    const connectionInfo = document.getElementById('connectionInfo');

    // Initialisation Firebase
    function initializeFirebase() {
      try {
        if (firebaseConfig.apiKey === "demo-api-key") {
          throw new Error("Configuration demo d√©tect√©e");
        }
        
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        firebaseEnabled = true;
        
        console.log("‚úÖ Firebase initialis√© avec succ√®s");
        document.getElementById('offlineNotice').style.display = 'none';
        
      } catch (error) {
        console.warn("‚ö†Ô∏è Firebase non configur√©:", error.message);
        firebaseEnabled = false;
        
        // Afficher le message d'aide
        document.getElementById('firebaseSetup').style.display = 'block';
        document.getElementById('offlineNotice').style.display = 'block';
        
        // D√©sactiver les boutons multijoueur
        document.getElementById('hostBtn').disabled = true;
        document.getElementById('joinBtn').disabled = true;
        document.getElementById('hostBtn').innerHTML = 'üñ•Ô∏è Mode H√¥te<br><small>Firebase requis</small>';
        document.getElementById('joinBtn').innerHTML = 'üì± Rejoindre<br><small>Firebase requis</small>';
      }
    }

    // Mode Solo (fonctionne toujours)
    function startSoloMode() {
      currentMode = 'solo';
      mainMenu.style.display = 'none';
      gameArea.style.display = 'block';
      
      questions = shuffleArray([...questionsBySubject]).slice(0, 5);
      currentQuestionIndex = 0;
      score = 0;
      
      showQuestion();
    }

    // Mode H√¥te (Firebase requis)
    function startHostMode() {
      if (!firebaseEnabled) {
        alert('‚ùå Firebase n\'est pas configur√©. Le mode multijoueur est indisponible.');
        return;
      }
      
      const hostName = prompt('Entrez votre nom (h√¥te):') || 'H√¥te';
      roomCode = generateRoomCode();
      
      currentMode = 'host';
      mainMenu.style.display = 'none';
      gameArea.style.display = 'block';
      connectionInfo.style.display = 'block';
      
      // Cr√©er la partie dans Firebase
      createFirebaseRoom(hostName);
      
      document.getElementById('roomCode').innerHTML = `
        <h3>üè† Vous √™tes l'h√¥te (${hostName})</h3>
        <div style="font-size: 1.5em; margin: 15px 0; color: #FFD700;">
          Code de partie: <strong>${roomCode}</strong>
        </div>
        <p>Partagez ce code avec les joueurs !</p>
        <div style="margin: 20px 0;">
          <button onclick="startQuizAsHost()" style="font-size: 1.2em; padding: 15px 30px; background: #28a745;">
            üöÄ D√©marrer le Quiz
          </button>
        </div>
      `;
      
      const url = `${window.location.origin}${window.location.pathname}?join=${roomCode}`;
      document.getElementById('qrCode').innerHTML = `
        <div style="color: #333; padding: 10px;">
          <strong>URL √† partager :</strong><br>
          <small style="word-break: break-all;">${url}</small><br>
          <button onclick="copyToClipboard('${url}')" style="margin-top: 10px; padding: 8px 15px; font-size: 0.9em;">
            üìã Copier l'URL
          </button>
        </div>
      `;
      document.getElementById('qrCode').style.display = 'block';
      
      questionContainer.innerHTML = `
        <div style="text-align: center; font-size: 1.3em; padding: 40px;">
          üë• <strong>En attente des joueurs...</strong><br><br>
          <div style="margin: 20px 0;">
            Les joueurs peuvent rejoindre avec le code: <strong style="color: #FFD700;">${roomCode}</strong>
          </div>
          <div style="font-size: 0.9em; opacity: 0.8;">
            üí° Cliquez sur "D√©marrer le Quiz" quand tout le monde est pr√™t !
          </div>
        </div>
      `;
      
      // Initialiser les questions
      questions = shuffleArray([...questionsBySubject]).slice(0, 5);
      currentQuestionIndex = 0;
      score = 0;
      
      // √âcouter les changements de joueurs
      listenToPlayers();
    }

    // Interface pour rejoindre une partie
    function showJoinInterface() {
      if (!firebaseEnabled) {
        alert('‚ùå Firebase n\'est pas configur√©. Le mode multijoueur est indisponible.');
        return;
      }
      
      mainMenu.style.display = 'none';
      gameArea.style.display = 'block';
      
      questionContainer.innerHTML = `
        <div class="question-card" style="text-align: center;">
          <div class="question-title">üéÆ Rejoindre une partie</div>
          <div style="margin: 20px 0;">
            <input type="text" id="joinRoomCode" placeholder="Code de la partie" 
                   style="padding: 15px; font-size: 1.2em; border: 2px solid #ddd; border-radius: 10px; margin: 10px; width: 200px; text-align: center; text-transform: uppercase;">
          </div>
          <div style="margin: 20px 0;">
            <input type="text" id="playerNameInput" placeholder="Votre nom" 
                   style="padding: 15px; font-size: 1.2em; border: 2px solid #ddd; border-radius: 10px; margin: 10px; width: 200px; text-align: center;">
          </div>
          <div style="margin: 20px 0;">
            <button onclick="attemptJoinRoom()" style="font-size: 1.2em; padding: 15px 30px; background: #28a745;">
              üö™ Rejoindre la partie
            </button>
            <button onclick="goHome()" style="font-size: 1.2em; padding: 15px 30px; background: #6c757d;">
              üè† Retour
            </button>
          </div>
          <div id="joinError" style="color: #e17055; margin: 10px 0; font-weight: bold;"></div>
        </div>
      `;
      
      // Auto-remplir si on vient d'une URL
      const urlParams = new URLSearchParams(window.location.search);
      const joinCode = urlParams.get('join');
      if (joinCode) {
        document.getElementById('joinRoomCode').value = joinCode;
      }
    }

    // Tentative de rejoindre une partie
    async function attemptJoinRoom() {
      const code = document.getElementById('joinRoomCode').value.toUpperCase().trim();
      const name = document.getElementById('playerNameInput').value.trim();
      const errorDiv = document.getElementById('joinError');
      
      if (!code) {
        errorDiv.textContent = '‚ùå Veuillez entrer un code de partie';
        return;
      }
      
      if (!name) {
        errorDiv.textContent = '‚ùå Veuillez entrer votre nom';
        return;
      }
      
      try {
        // V√©rifier si la partie existe
        const roomSnapshot = await database.ref(`rooms/${code}`).once('value');
        
        if (!roomSnapshot.exists()) {
          errorDiv.textContent = '‚ùå Code de partie invalide';
          return;
        }
        
        const roomData = roomSnapshot.val();
        
        if (roomData.status !== 'waiting') {
          errorDiv.textContent = '‚ùå Cette partie a d√©j√† commenc√© ou est termin√©e';
          return;
        }
        
        // Rejoindre la partie
        await joinFirebaseRoom(code, name);
        startPlayerMode(code, name);
        
      } catch (error) {
        console.error('Erreur lors de la connexion:', error);
        errorDiv.textContent = '‚ùå Erreur de connexion';
      }
    }

    // Mode Joueur
    function startPlayerMode(code, name) {
      currentMode = 'player';
      roomCode = code;
      playerName = name;
      
      connectionInfo.style.display = 'block';
      
      document.getElementById('roomCode').innerHTML = `
        <h3>üì± Joueur: ${name}</h3>
        <div>Partie: <strong>${roomCode}</strong></div>
        <p>‚úÖ Connexion r√©ussie !</p>
      `;
      
      questionContainer.innerHTML = `
        <div style="text-align: center; font-size: 1.3em; padding: 40px;">
          ‚è≥ <strong>En attente de l'h√¥te...</strong><br><br>
          <div style="margin: 20px 0;">
            L'h√¥te va d√©marrer le quiz quand tout le monde sera pr√™t
          </div>
          <div style="font-size: 0.9em; opacity: 0.8;">
            üí° Restez sur cette page, le quiz commencera automatiquement !
          </div>
        </div>
      `;
      
      // √âcouter les changements de la partie
      listenToRoomChanges();
      listenToPlayers();
    }

    // Fonctions Firebase
    function generateRoomCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    async function createFirebaseRoom(hostName) {
      roomRef = database.ref(`rooms/${roomCode}`);
      playersRef = database.ref(`rooms/${roomCode}/players`);
      
      await roomRef.set({
        hostName: hostName,
        status: 'waiting',
        currentQuestion: 0,
        questions: questions,
        created: firebase.database.ServerValue.TIMESTAMP
      });
    }

    async function joinFirebaseRoom(code, name) {
      roomCode = code;
      playerName = name;
      roomRef = database.ref(`rooms/${roomCode}`);
      playersRef = database.ref(`rooms/${roomCode}/players`);
      
      await playersRef.child(name).set({
        name: name,
        score: 0,
        status: 'connected',
        answers: {},
        joined: firebase.database.ServerValue.TIMESTAMP
      });
    }

    function listenToRoomChanges() {
      if (!roomRef) return;
      
      roomRef.on('value', (snapshot) => {
        const roomData = snapshot.val();
        if (!roomData) return;
        
        // Synchroniser l'√©tat du quiz
        if (roomData.status === 'playing' && currentMode === 'player') {
          if (currentQuestionIndex === 0 && !hasAnswered) {
            document.getElementById('roomCode').innerHTML = `
              <h3>üì± Quiz d√©marr√©</h3>
              <div>Partie: <strong>${roomCode}</strong></div>
              <p>üéØ R√©pondez aux questions !</p>
            `;
            questions = roomData.questions;
            showQuestion();
          }
          
          // V√©rifier si l'h√¥te a chang√© de question
          if (roomData.currentQuestion !== currentQuestionIndex) {
            currentQuestionIndex = roomData.currentQuestion;
            if (currentQuestionIndex < questions.length) {
              showQuestion();
            } else {
              showFinalResults();
            }
          }
        }
        
        if (roomData.status === 'finished') {
          showFinalResults();
        }
      });
    }

    function listenToPlayers() {
      if (!playersRef) return;
      
      playersRef.on('value', (snapshot) => {
        const players = snapshot.val() || {};
        updatePlayersDisplay(players);
      });
    }

    // D√©marrer le quiz (appel√© par l'h√¥te)
    async function startQuizAsHost() {
      await roomRef.update({ 
        status: 'playing',
        questions: questions
      });
      
      document.getElementById('roomCode').innerHTML = `
        <h3>üè† Quiz en cours</h3>
        <div>Partie: <strong>${roomCode}</strong></div>
        <p>üéØ Vous contr√¥lez le quiz</p>
      `;
      
      showQuestion();
    }

    // Question suivante (contr√¥l√©e par l'h√¥te)
    async function nextQuestionAsHost() {
      currentQuestionIndex++;
      await roomRef.update({ currentQuestion: currentQuestionIndex });
      showQuestion();
    }

    // Terminer le quiz manuellement (h√¥te)
    async function endQuizAsHost() {
      if (confirm('√ätes-vous s√ªr de vouloir terminer le quiz maintenant ?')) {
        currentQuestionIndex = questions.length;
        await roomRef.update({ 
          currentQuestion: currentQuestionIndex,
          status: 'finished'
        });
        showFinalResults();
      }
    }

    // Mettre √† jour l'affichage des joueurs
    function updatePlayersDisplay(players) {
      const playersListDiv = document.getElementById('playersList');
      if (!playersListDiv) return;
      
      const playersList = Object.values(players || {});
      
      if (playersList.length === 0) {
        playersListDiv.innerHTML = `
          <div class="players-list">
            <h4>üë• Joueurs connect√©s (0)</h4>
            <p style="opacity: 0.7;">Aucun joueur pour le moment...</p>
          </div>
        `;
        return;
      }
      
      let html = `
        <div class="players-list">
          <h4>üë• Joueurs connect√©s (${playersList.length})</h4>
      `;
      
      playersList.forEach(player => {
        let statusClass = 'status-connected';
        let statusText = 'Connect√©';
        
        if (currentMode === 'host') {
          const hasAnsweredCurrent = player.answers && player.answers[currentQuestionIndex];
          statusClass = hasAnsweredCurrent ? 'status-answered' : 'status-waiting';
          statusText = hasAnsweredCurrent ? 'R√©pondu' : 'En cours...';
        }
        
        html += `
          <div class="player-item">
            <span>üéÆ ${player.name}</span>
            <span class="status-indicator ${statusClass}">${statusText}</span>
          </div>
        `;
      });
      
      html += '</div>';
      playersListDiv.innerHTML = html;
    }

    // Afficher une question
    function showQuestion() {
      if (currentQuestionIndex >= questions.length) {
        showFinalResults();
        return;
      }
      
      const question = questions[currentQuestionIndex];
      hasAnswered = false;
      selectedChoices = [];
      
      let html = '';
      
      if (currentMode === 'host') {
        // Vue h√¥te - contr√¥le le quiz
        html = `
          <div class="question-card">
            <div class="question-title">
              üëë Question ${currentQuestionIndex + 1}/${questions.length}: ${question.title}
            </div>
            <div style="margin: 20px 0; padding: 15px; background: rgba(0,200,0,0.1); border-radius: 10px;">
              <strong>‚úÖ R√©ponses correctes :</strong><br>
        `;
        
        question.choices.forEach((choice, i) => {
          const isCorrect = question.answer.includes(i);
          html += `
            <div style="margin: 8px 0; padding: 10px; background: ${isCorrect ? '#c8e6c9' : '#f5f5f5'}; border-radius: 5px;">
              ${isCorrect ? '‚úÖ' : '‚óØ'} ${choice}
            </div>
          `;
        });
        
        html += `
            </div>
            <div style="text-align: center; margin: 20px 0;">
              <button onclick="nextQuestionAsHost()" style="font-size: 1.2em; padding: 15px 30px; background: #17a2b8; margin: 5px;">
                ‚û°Ô∏è Question suivante
              </button>
              <button onclick="endQuizAsHost()" style="font-size: 1.2em; padding: 15px 30px; background: #dc3545; margin: 5px;">
                üèÅ Terminer le quiz
              </button>
            </div>
            <div style="font-size: 0.9em; opacity: 0.7; text-align: center;">
              üí° Les joueurs voient cette question et peuvent r√©pondre
            </div>
          </div>
        `;
        
      } else {
        // Vue joueur/solo - peut r√©pondre
        timeLeft = 30;
        startTimer();
        
        html = `
          <div class="question-card">
            <div class="question-title">
              Question ${currentQuestionIndex + 1}/${questions.length}: ${question.title}
            </div>
            <div class="choices">
        `;
        
        question.choices.forEach((choice, i) => {
          html += `
            <div class="choice" onclick="selectChoice(${i})" data-choice="${i}">
              ${choice}
            </div>
          `;
        });
        
        html += `
            </div>
            <button onclick="submitAnswer()" id="submitBtn">üìù Valider ma r√©ponse</button>
          </div>
        `;
      }
      
      questionContainer.innerHTML = html;
      updateScore();
      updateProgress();
    }

    // S√©lectionner une r√©ponse
    function selectChoice(choiceIndex) {
      if (hasAnswered) return;
      
      const choice = document.querySelector(`[data-choice="${choiceIndex}"]`);
      
      if (choice.classList.contains('selected')) {
        choice.classList.remove('selected');
        selectedChoices = selectedChoices.filter(i => i !== choiceIndex);
      } else {
        choice.classList.add('selected');
        selectedChoices.push(choiceIndex);
      }
    }

    // Soumettre la r√©ponse
    async function submitAnswer() {
      if (hasAnswered || selectedChoices.length === 0) {
        if (selectedChoices.length === 0) {
          alert('Veuillez s√©lectionner au moins une r√©ponse !');
        }
        return;
      }
      
      hasAnswered = true;
      const currentQuestion = questions[currentQuestionIndex];
      
      clearInterval(timer);
      
      // V√©rifier la r√©ponse
      const isCorrect = JSON.stringify(selectedChoices.sort()) === JSON.stringify(currentQuestion.answer.sort());
      if (isCorrect) score++;
      
      // Enregistrer la r√©ponse du joueur dans Firebase
      if (currentMode === 'player' && playersRef) {
        try {
          await playersRef.child(`${playerName}/answers/${currentQuestionIndex}`).set({
            selected: selectedChoices,
            correct: isCorrect,
            timestamp: firebase.database.ServerValue.TIMESTAMP
          });
          
          await playersRef.child(`${playerName}/score`).set(score);
        } catch (error) {
          console.error('Erreur lors de l\'enregistrement:', error);
        }
      }
      
      // Afficher le feedback
      document.querySelectorAll('.choice').forEach((choice, i) => {
        const isCorrectAnswer = currentQuestion.answer.includes(i);
        const isSelected = selectedChoices.includes(i);
        
        choice.style.pointerEvents = 'none';
        
        if (isCorrectAnswer) {
          choice.classList.add('correct');
        } else if (isSelected) {
          choice.classList.add('incorrect');
        }
      });
      
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('submitBtn').textContent = isCorrect ? '‚úÖ Correct !' : '‚ùå Incorrect';
      
      // En mode solo, passer automatiquement √† la question suivante
      if (currentMode === 'solo') {
        setTimeout(() => {
          currentQuestionIndex++;
          showQuestion();
        }, 3000);
      } else {
        document.getElementById('submitBtn').textContent += ' - En attente de la question suivante...';
      }
    }

    // Timer
    function startTimer() {
      if (currentMode === 'host') {
        timerDisplay.textContent = '';
        return;
      }
      
      timer = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `‚è±Ô∏è ${timeLeft}s`;
        
        if (timeLeft <= 0) {
          clearInterval(timer);
          if (!hasAnswered) {
            submitAnswer();
          }
        }
      }, 1000);
    }

    // Mise √† jour du score
    function updateScore() {
      if (currentMode === 'host') {
        scoreDisplay.textContent = `üëë H√¥te - Question ${currentQuestionIndex + 1}/${questions.length}`;
      } else {
        scoreDisplay.textContent = `Score: ${score}/${currentQuestionIndex} | Question ${currentQuestionIndex + 1}/${questions.length}`;
      }
    }

    // Mise √† jour de la progression
    function updateProgress() {
      const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
      progressFill.style.width = progress + '%';
    }

    // R√©sultats finaux
    async function showFinalResults() {
      clearInterval(timer);
      timerDisplay.textContent = '';
      
      let html = '';
      
      if (currentMode === 'host') {
        // Vue h√¥te - r√©sultats globaux
        let players = {};
        
        if (playersRef) {
          try {
            const snapshot = await playersRef.once('value');
            players = snapshot.val() || {};
          } catch (error) {
            console.error('Erreur lors de la r√©cup√©ration des scores:', error);
          }
        }
        
        const playersList = Object.values(players);
        
        html = `
          <div class="final-results">
            <h2>üèÜ Quiz termin√© !</h2>
            <div style="font-size: 1.5em; margin: 20px 0;">
              üëë Vous avez anim√© le quiz avec succ√®s !
            </div>
            <div style="font-size: 1.2em; margin: 15px 0;">
              ${questions.length} questions pr√©sent√©es √† ${playersList.length} joueur(s)
            </div>
        `;
        
        if (playersList.length > 0) {
          // Classement des joueurs
          playersList.sort((a, b) => (b.score || 0) - (a.score || 0));
          
          html += `
            <div style="margin: 20px 0;">
              <h3>üèÖ Classement final :</h3>
              <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin: 10px 0;">
          `;
          
          playersList.forEach((player, index) => {
            const trophy = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
            const percentage = Math.round(((player.score || 0) / questions.length) * 100);
            
            html += `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; margin: 5px 0; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <span>${trophy} ${player.name}</span>
                <span style="font-weight: bold;">${player.score || 0}/${questions.length} (${percentage}%)</span>
              </div>
            `;
          });
          
          html += '</div></div>';
        }
        
        html += `
            <button onclick="restart()" style="font-size: 1.2em; padding: 15px 30px;">
              üîÑ Nouveau quiz
            </button>
            <button onclick="goHome()" style="font-size: 1.2em; padding: 15px 30px; background: #6c757d;">
              üè† Menu principal
            </button>
          </div>
        `;
        
      } else {
        // Vue joueur/solo - score personnel
        const percentage = Math.round((score / questions.length) * 100);
        
        let performance = '';
        if (percentage >= 80) performance = 'üèÜ Excellent !';
        else if (percentage >= 60) performance = 'üëè Bien jou√© !';
        else if (percentage >= 40) performance = 'üìö √Ä retravailler';
        else performance = 'üí™ Continuez vos efforts !';
        
        html = `
          <div class="final-results">
            <h2>üéØ Quiz termin√© !</h2>
            <div style="font-size: 2em; margin: 20px 0;">
              ${score}/${questions.length}
            </div>
            <div style="font-size: 1.5em; margin: 15px 0;">
              ${percentage}% de r√©ussite
            </div>
            <div style="font-size: 1.3em; margin: 15px 0;">
              ${performance}
            </div>
            <button onclick="restart()" style="font-size: 1.2em; padding: 15px 30px;">
              üîÑ Refaire un quiz
            </button>
            <button onclick="goHome()" style="font-size: 1.2em; padding: 15px 30px; background: #6c757d;">
              üè† Menu principal
            </button>
          </div>
        `;
      }
      
      questionContainer.innerHTML = html;
    }

    // Red√©marrer
    function restart() {
      // Nettoyer les r√©f√©rences Firebase
      if (roomRef) {
        roomRef.off();
        roomRef = null;
      }
      if (playersRef) {
        playersRef.off();
        playersRef = null;
      }
      
      if (currentMode === 'solo') {
        startSoloMode();
      } else if (currentMode === 'host') {
        startHostMode();
      } else {
        showJoinInterface();
      }
    }

    // Retour au menu
    function goHome() {
      // Nettoyer les r√©f√©rences Firebase
      if (roomRef) {
        roomRef.off();
        roomRef = null;
      }
      if (playersRef) {
        playersRef.off();
        playersRef = null;
      }
      
      gameArea.style.display = 'none';
      connectionInfo.style.display = 'none';
      mainMenu.style.display = 'block';
      clearInterval(timer);
    }

    // Utilitaires
    function shuffleArray(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('URL copi√©e dans le presse-papier !');
      }).catch(() => {
        prompt('Copiez cette URL:', text);
      });
    }

    // Auto-join via URL
    window.addEventListener('load', () => {
      initializeFirebase();
      
      const urlParams = new URLSearchParams(window.location.search);
      const joinCode = urlParams.get('join');
      if (joinCode && firebaseEnabled) {
        setTimeout(() => showJoinInterface(), 1000);
      }
    });

    // Nettoyage automatique des anciennes parties (toutes les 24h)
    if (firebaseEnabled) {
      setInterval(() => {
        const cutoff = Date.now() - (24 * 60 * 60 * 1000); // 24 heures
        database.ref('rooms').orderByChild('created').endAt(cutoff).once('value')
          .then(snapshot => {
            const updates = {};
            snapshot.forEach(childSnapshot => {
              updates[childSnapshot.key] = null;
            });
            return database.ref('rooms').update(updates);
          })
          .catch(error => console.warn('Erreur de nettoyage:', error));
      }, 60 * 60 * 1000); // V√©rifier toutes les heures
    }
  </script>
</body>
</html>
