<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz DWWM Interactif Multijoueur</title>
  <style>
    :root { 
      --color-bg-start: #667eea; 
      --color-bg-end: #764ba2; 
      --color-primary: #74b9ff; 
      --color-success: #00b894; 
      --color-error: #e17055; 
      --color-warning: #fdcb6e;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Segoe UI', sans-serif; 
      background: linear-gradient(135deg, var(--color-bg-start), var(--color-bg-end)); 
      min-height: 100vh; 
      padding: 20px; 
      color: white;
    }
    
    .container { 
      max-width: 900px; 
      margin: auto; 
      background: rgba(255,255,255,0.1); 
      border-radius: 20px; 
      padding: 30px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      text-align: center;
    }
    
    h1 { 
      font-size: 2.5em; 
      margin-bottom: 20px; 
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .mode-selector {
      margin: 30px 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
    }
    
    .mode-card {
      background: rgba(255,255,255,0.15);
      border-radius: 15px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .mode-card:hover {
      transform: translateY(-5px);
      border-color: var(--color-primary);
      background: rgba(255,255,255,0.25);
    }
    
    .mode-card h3 {
      font-size: 1.3em;
      margin-bottom: 10px;
      color: #FFD700;
    }
    
    .type-selector {
      margin: 20px 0;
      display: none;
    }
    
    .type-btn {
      display: inline-block;
      margin: 5px;
      padding: 10px 15px;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .type-btn:hover, .type-btn.selected {
      background: var(--color-primary);
      border-color: var(--color-primary);
    }
    
    .game-area {
      background: rgba(255,255,255,0.2);
      border-radius: 15px;
      padding: 25px;
      margin: 20px 0;
      min-height: 400px;
      display: none;
    }
    
    .question-card {
      background: rgba(255,255,255,0.95);
      color: #333;
      border-radius: 15px;
      padding: 25px;
      margin: 15px 0;
      text-align: left;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }
    
    .question-type {
      background: var(--color-primary);
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
    }
    
    .question-title {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #2c3e50;
      line-height: 1.5;
    }
    
    .choice {
      display: block;
      margin: 12px 0;
      padding: 15px;
      background: #f8f9fa;
      border: 2px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .choice:hover {
      background: #e3f2fd;
      border-color: var(--color-primary);
      transform: translateX(5px);
    }
    
    .choice.selected {
      background: #bbdefb;
      border-color: var(--color-primary);
    }
    
    .choice.correct {
      background: #c8e6c9 !important;
      border-color: var(--color-success) !important;
      color: #2e7d32;
    }
    
    .choice.incorrect {
      background: #ffcdd2 !important;
      border-color: var(--color-error) !important;
      color: #c62828;
    }
    
    .explanation {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      display: none;
    }
    
    .explanation.show {
      display: block;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    button {
      background: linear-gradient(135deg, var(--color-primary), #0984e3);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      margin: 10px;
      transition: transform 0.2s;
    }
    
    button:hover { transform: translateY(-3px); }
    button:disabled { 
      background: #999; 
      cursor: not-allowed; 
      transform: none; 
    }
    
    .score-display {
      font-size: 1.3em;
      margin: 20px 0;
      padding: 15px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .progress-bar {
      background: rgba(255,255,255,0.3);
      border-radius: 10px;
      height: 8px;
      margin: 15px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      background: linear-gradient(90deg, #00d2ff, #3a7bd5);
      height: 100%;
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 10px;
    }
    
    .final-results {
      background: linear-gradient(135deg, #ff9a9e, #fad0c4);
      color: #333;
      border-radius: 15px;
      padding: 30px;
      margin: 20px 0;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: rgba(255,255,255,0.2);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }
    
    .timer {
      font-size: 1.5em;
      font-weight: bold;
      color: #FFD700;
      margin: 10px 0;
    }
    
    .missed-questions {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      text-align: left;
    }
    
    .review-btn {
      background: var(--color-warning);
      color: #333;
    }
    
    /* Styles sp√©cifiques multijoueur */
    .answer-status {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
    }
    
    .player-answer-status {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin: 10px 0;
    }
    
    .player-status-chip {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 15px;
      color: white;
      font-size: 0.9em;
      margin: 2px;
    }
    
    .player-status-chip.answered {
      background: #28a745;
    }
    
    .player-status-chip.waiting {
      background: #6c757d;
    }
    
    .choice-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .choice-stats .percentage {
      background: rgba(0,0,0,0.1);
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.9em;
    }
    
    .stats-card {
      text-align: center;
      padding: 15px;
      border-radius: 10px;
      margin: 5px;
    }
    
    .stats-card.correct {
      background: rgba(40, 167, 69, 0.2);
      color: #28a745;
    }
    
    .stats-card.incorrect {
      background: rgba(220, 53, 69, 0.2);
      color: #dc3545;
    }
    
    .stats-card.percentage {
      background: rgba(23, 162, 184, 0.2);
      color: #17a2b8;
    }
    
    /* Styles pour la configuration de quiz */
    .quiz-config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    
    .type-checkbox {
      display: flex;
      align-items: center;
      padding: 15px;
      background: rgba(255,255,255,0.1);
      border: 2px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .type-checkbox:hover {
      background: rgba(255,255,255,0.2);
      border-color: var(--color-primary);
    }
    
    .type-checkbox input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }
    
    .type-checkbox input[type="checkbox"]:checked + .type-label {
      color: var(--color-primary);
      font-weight: bold;
    }
    
    .type-checkbox.special {
      background: rgba(255,215,0,0.1);
      border-color: rgba(255,215,0,0.3);
    }
    
    .type-label {
      flex: 1;
      font-weight: 500;
    }
    
    .type-count {
      opacity: 0.7;
      font-size: 0.85em;
    }
    
    .format-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 15px 0;
    }
    
    .format-option {
      display: flex;
      align-items: flex-start;
      padding: 20px;
      background: rgba(255,255,255,0.1);
      border: 2px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .format-option:hover {
      background: rgba(255,255,255,0.2);
      border-color: var(--color-primary);
    }
    
    .format-option input[type="radio"] {
      margin-right: 15px;
      margin-top: 3px;
      transform: scale(1.2);
    }
    
    .format-option input[type="radio"]:checked ~ .format-content {
      color: var(--color-primary);
    }
    
    .format-content strong {
      display: block;
      font-size: 1.1em;
      margin-bottom: 5px;
    }
    
    .format-content p {
      font-size: 0.9em;
      opacity: 0.8;
      margin: 0;
    }
    
    .series-selector {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      justify-content: center;
    }
    
    .series-btn {
      width: 50px;
      height: 50px;
      border: 2px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      color: white;
      border-radius: 50%;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .series-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: var(--color-primary);
    }
    
    .series-btn.selected {
      background: var(--color-primary);
      border-color: var(--color-primary);
      transform: scale(1.1);
    }
    
    .config-summary {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      border-left: 4px solid var(--color-primary);
    }
    
    .final-config {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
    
    .config-item {
      margin: 10px 0;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .config-item:last-child {
      border-bottom: none;
    }
    
    .series-results {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin: 20px 0;
    }
    
    .series-podium {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .podium-item {
      background: rgba(255,255,255,0.15);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      position: relative;
    }
    
    .podium-item.first {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #333;
    }
    
    .podium-item.second {
      background: linear-gradient(135deg, #C0C0C0, #A9A9A9);
      color: #333;
    }
    
    .podium-item.third {
      background: linear-gradient(135deg, #CD7F32, #B87333);
      color: white;
    }
    
    /* Styles pour les r√©sultats finaux */
    .results-tabs {
      display: flex;
      justify-content: center;
      margin: 20px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 5px;
    }
    
    .tab-btn {
      background: transparent;
      border: none;
      padding: 12px 20px;
      margin: 0 5px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1em;
    }
    
    .tab-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .tab-btn.active {
      background: var(--color-primary);
      color: white;
      transform: none;
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .question-summary {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .question-summary:hover {
      background: rgba(255,255,255,0.15);
      transform: translateX(5px);
    }
    
    .question-summary-header {
      display: flex;
      align-items: center;
      padding: 15px;
      gap: 15px;
    }
    
    .question-number {
      background: var(--color-primary);
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-weight: bold;
      min-width: 40px;
      text-align: center;
    }
    
    .question-type-small {
      background: rgba(255,255,255,0.2);
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.85em;
      white-space: nowrap;
    }
    
    .question-title-small {
      flex: 1;
      font-weight: 500;
    }
    
    .expand-icon {
      font-size: 1.2em;
      transition: transform 0.3s ease;
    }
    
    .question-details {
      padding: 0 15px 15px 15px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .question-choices-review {
      margin: 15px 0;
    }
    
    .choice-review {
      padding: 10px;
      margin: 8px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      border-left: 3px solid transparent;
    }
    
    .choice-review.correct {
      background: rgba(40, 167, 69, 0.2);
      border-left-color: #28a745;
      color: #28a745;
      font-weight: 500;
    }
    
    .explanation-review {
      background: rgba(255, 243, 205, 0.9);
      color: #856404;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
    }
    
    .explanation-review h4 {
      color: #856404;
      margin-bottom: 10px;
    }
    
    .question-stats {
      margin: 15px 0;
    }
    
    /* Styles multijoueur */
    .connection-info {
      background: rgba(255,255,255,0.15);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      font-size: 0.9em;
    }
    
    .qr-code {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin: 20px auto;
      display: inline-block;
      color: #333;
    }
    
    .players-list {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
    }
    
    .player-item {
      background: rgba(255,255,255,0.2);
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .player-name {
      font-weight: bold;
    }
    
    .player-score {
      background: var(--color-success);
      color: white;
      padding: 3px 8px;
      border-radius: 15px;
      font-size: 0.9em;
    }
    
    .waiting-room {
      text-align: center;
      padding: 40px 20px;
    }
    
    .room-code-display {
      font-size: 2em;
      font-weight: bold;
      color: #FFD700;
      margin: 20px 0;
      letter-spacing: 3px;
    }
    
    .join-input {
      padding: 15px;
      font-size: 1.2em;
      border: none;
      border-radius: 10px;
      margin: 10px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ Quiz DWWM Pro</h1>
    
    <!-- Menu principal -->
    <div id="mainMenu">
      <div class="mode-selector">
        <div class="mode-card" onclick="selectMode('selftest')">
          <h3>‚ö° Test Rapide</h3>
          <p>10 questions al√©atoires pour un entra√Ænement express</p>
        </div>
        
        <div class="mode-card" onclick="selectMode('onepertype')">
          <h3>üéØ Tour d'horizon</h3>
          <p>Une question de chaque type pour tester tous vos domaines</p>
        </div>
        
        <div class="mode-card" onclick="selectMode('typetest')">
          <h3>üìö Test cibl√©</h3>
          <p>8 questions sur un domaine sp√©cifique</p>
        </div>
        
        <div class="mode-card" onclick="selectMode('fulltypetest')">
          <h3>üéì Ma√Ætrise compl√®te</h3>
          <p>Toutes les questions d'un domaine</p>
        </div>
        
        <div class="mode-card" onclick="selectMode('review')">
          <h3>üîÑ R√©vision cibl√©e</h3>
          <p>Revoir les questions o√π vous avez fait des erreurs</p>
        </div>
        
        <div class="mode-card" onclick="selectMode('fulltest')">
          <h3>üèÜ Super Test</h3>
          <p>Toutes les questions de la base de donn√©es</p>
        </div>
        
        <div class="mode-card" onclick="selectMode('host')">
          <h3>üñ•Ô∏è Mode H√¥te</h3>
          <p>Cr√©er une partie multijoueur</p>
        </div>
        
        <div class="mode-card" onclick="selectMode('join')">
          <h3>üì± Rejoindre</h3>
          <p>Participer √† une partie multijoueur</p>
        </div>
      </div>
      
      <div class="type-selector" id="typeSelector">
        <h3>Choisissez un domaine :</h3>
        <div id="typeButtons"></div>
        <button onclick="startSelectedMode()" id="startBtn" style="display:none;">D√©marrer le quiz</button>
      </div>
    </div>
    
    <!-- Zone de jeu -->
    <div class="game-area" id="gameArea">
      <div class="score-display" id="scoreDisplay">
        <div id="scoreText"></div>
        <div id="timerDisplay" class="timer"></div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div id="questionContainer"></div>
    </div>
    
    <!-- Section multijoueur -->
    <div class="connection-info" id="connectionInfo" style="display:none;">
      <div id="roomCode"></div>
      <div class="qr-code" id="qrCode" style="display:none;"></div>
      <div id="playersList"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ‚ö†Ô∏è CONFIGURATION FIREBASE - VOS VRAIES VALEURS
    const firebaseConfig = {
      apiKey: "AIzaSyCOegG19Z-G04jRXBA3aXUSLTrHrPtEwbQ",
      authDomain: "quiz-4321f.firebaseapp.com",
      databaseURL: "https://quiz-4321f-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "quiz-4321f"
    };

    // Initialiser Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Base de donn√©es de questions enrichie
    const questionsBySubject = {
      "HTML/CSS": [
        {
          id: 1,
          type: "HTML/CSS",
          title: "Quelle est la diff√©rence principale entre HTML et CSS ?",
          choices: [
            "HTML g√®re la structure, CSS g√®re la pr√©sentation",
            "HTML est pour les images, CSS pour le texte",
            "HTML est obsol√®te, CSS est moderne",
            "Il n'y a pas de diff√©rence"
          ],
          answer: [0],
          explanation: "<h4>Explication</h4><p><strong>HTML</strong> (HyperText Markup Language) d√©finit la structure et le contenu d'une page web avec des balises s√©mantiques, tandis que <strong>CSS</strong> (Cascading Style Sheets) contr√¥le la pr√©sentation visuelle, les couleurs, les polices et la mise en page.</p>"
        },
        {
          id: 2,
          type: "HTML/CSS",
          title: "Quelles propri√©t√©s CSS permettent de cr√©er une mise en page flexible ?",
          choices: ["display: block", "display: flex", "display: grid", "display: table"],
          answer: [1, 2],
          explanation: "<h4>Explication</h4><p><strong>Flexbox</strong> (display: flex) et <strong>CSS Grid</strong> (display: grid) sont les deux syst√®mes de mise en page modernes qui permettent de cr√©er des designs responsives et flexibles facilement.</p>"
        },
        {
          id: 3,
          type: "HTML/CSS",
          title: "Quelle balise HTML est s√©mantiquement correcte pour un titre principal ?",
          choices: ["<title>", "<h1>", "<header>", "<main>"],
          answer: [1],
          explanation: "<h4>Explication</h4><p>La balise <strong>&lt;h1&gt;</strong> repr√©sente le titre principal d'une page ou section. Elle est cruciale pour l'accessibilit√© et le SEO.</p>"
        }
      ],
      
      "JavaScript": [
        {
          id: 4,
          type: "JavaScript",
          title: "Quels sont les types de donn√©es primitifs en JavaScript ?",
          choices: ["string", "number", "boolean", "object"],
          answer: [0, 1, 2],
          explanation: "<h4>Explication</h4><p>Les types primitifs en JavaScript sont : <strong>string, number, boolean, undefined, null, symbol et bigint</strong>. L'object n'est pas un type primitif.</p>"
        },
        {
          id: 5,
          type: "JavaScript",
          title: "Quelle est la diff√©rence entre let, const et var ?",
          choices: [
            "let et const ont une port√©e de bloc, var une port√©e de fonction",
            "const permet la r√©assignation, let non",
            "var est plus r√©cent que let",
            "Il n'y a pas de diff√©rence"
          ],
          answer: [0],
          explanation: "<h4>Explication</h4><p><strong>let</strong> et <strong>const</strong> ont une port√©e de bloc et ne sont pas hiss√©es. <strong>const</strong> ne peut pas √™tre r√©assign√©. <strong>var</strong> a une port√©e de fonction et est hiss√©.</p>"
        },
        {
          id: 6,
          type: "JavaScript",
          title: "Comment d√©clarer une fonction en JavaScript ?",
          choices: [
            "function nom() {}",
            "const nom = () => {}",
            "const nom = function() {}",
            "def nom():"
          ],
          answer: [0, 1, 2],
          explanation: "<h4>Explication</h4><p>JavaScript offre plusieurs syntaxes : <strong>d√©claration de fonction</strong>, <strong>fonction fl√©ch√©e</strong> et <strong>expression de fonction</strong>. La syntaxe Python (def) n'existe pas en JavaScript.</p>"
        }
      ],
      
      "PHP": [
        {
          id: 7,
          type: "PHP",
          title: "Comment d√©marrer une session en PHP ?",
          choices: ["start_session()", "session_start()", "begin_session()", "session_begin()"],
          answer: [1],
          explanation: "<h4>Explication</h4><p>La fonction <strong>session_start()</strong> doit √™tre appel√©e au d√©but du script pour initialiser ou reprendre une session existante.</p>"
        },
        {
          id: 8,
          type: "PHP",
          title: "Quelles superglobales PHP permettent de r√©cup√©rer des donn√©es ?",
          choices: ["$_GET", "$_POST", "$_SESSION", "$_GLOBAL"],
          answer: [0, 1, 2],
          explanation: "<h4>Explication</h4><p><strong>$_GET</strong> r√©cup√®re les donn√©es d'URL, <strong>$_POST</strong> les donn√©es de formulaire, <strong>$_SESSION</strong> les donn√©es de session. $_GLOBAL n'existe pas (c'est $GLOBALS).</p>"
        }
      ],
      
      "Base de donn√©es": [
        {
          id: 9,
          type: "Base de donn√©es",
          title: "Que signifie CRUD en base de donn√©es ?",
          choices: [
            "Create, Read, Update, Delete",
            "Connect, Run, Use, Disconnect",
            "Copy, Replace, Upload, Download",
            "Call, Return, Update, Drop"
          ],
          answer: [0],
          explanation: "<h4>Explication</h4><p><strong>CRUD</strong> repr√©sente les quatre op√©rations de base sur les donn√©es : <strong>Create</strong> (cr√©er), <strong>Read</strong> (lire), <strong>Update</strong> (modifier), <strong>Delete</strong> (supprimer).</p>"
        },
        {
          id: 10,
          type: "Base de donn√©es",
          title: "Quelle commande SQL permet de r√©cup√©rer des donn√©es ?",
          choices: ["INSERT", "SELECT", "UPDATE", "DELETE"],
          answer: [1],
          explanation: "<h4>Explication</h4><p>La commande <strong>SELECT</strong> permet de r√©cup√©rer des donn√©es depuis une ou plusieurs tables de la base de donn√©es.</p>"
        }
      ],
      
      "IDE": [
        {
          id: 11,
          type: "IDE",
          title: "Qu'est-ce qu'un environnement de d√©veloppement int√©gr√© (IDE) ?",
          choices: [
            "Plugin de navigateur",
            "Logiciel combinant √©diteur de code, compilateur, d√©bogueur et outils de gestion de projet",
            "Suite bureautique",
            "Outil de gestion de versions"
          ],
          answer: [1],
          explanation: "<h4>Explication</h4><p>Un <strong>IDE</strong> fournit un √©diteur de code, un compilateur/interpr√©teur, un d√©bogueur et des outils de gestion de projet int√©gr√©s pour am√©liorer la productivit√© du d√©veloppeur.</p>"
        },
        {
          id: 12,
          type: "IDE",
          title: "Quels IDE sont populaires pour le d√©veloppement web ?",
          choices: ["Visual Studio Code", "PHPStorm", "WebStorm", "Microsoft Word"],
          answer: [0, 1, 2],
          explanation: "<h4>Explication</h4><p><strong>VS Code</strong> est gratuit et extensible, <strong>PHPStorm</strong> est sp√©cialis√© pour PHP, <strong>WebStorm</strong> pour JavaScript. Word n'est pas un IDE.</p>"
        }
      ]
    };

    // Variables globales
    let currentMode = '';
    let selectedType = '';
    let currentQuestionIndex = 0;
    let score = 0;
    let questions = [];
    let selectedChoices = [];
    let hasAnswered = false;
    let timeLeft = 30;
    let timer = null;
    let startTime = 0;
    let missedQuestions = JSON.parse(localStorage.getItem('dwwm_missed_questions') || '[]');
    
    // Variables multijoueur
    let isHost = false;
    let roomId = '';
    let playerName = '';
    let playerId = '';
    let gameState = 'waiting'; // waiting, playing, results
    let players = {};
    
    // Variables de configuration
    let configSelectedTypes = [];
    let configSeriesCount = 3;
    let configQuizFormat = 'series';
    
    // √âl√©ments DOM
    const mainMenu = document.getElementById('mainMenu');
    const gameArea = document.getElementById('gameArea');
    const typeSelector = document.getElementById('typeSelector');
    const typeButtons = document.getElementById('typeButtons');
    const questionContainer = document.getElementById('questionContainer');
    const scoreText = document.getElementById('scoreText');
    const progressFill = document.getElementById('progressFill');
    const timerDisplay = document.getElementById('timerDisplay');
    const connectionInfo = document.getElementById('connectionInfo');

    // S√©lection du mode
    function selectMode(mode) {
      currentMode = mode;
      
      if (mode === 'host') {
        startHostMode();
      } else if (mode === 'join') {
        startJoinMode();
      } else if (mode === 'typetest' || mode === 'fulltypetest') {
        showTypeSelector();
      } else if (mode === 'review') {
        if (missedQuestions.length === 0) {
          alert('Aucune question √† r√©viser ! Faites d\'abord quelques quiz pour accumuler des erreurs √† r√©viser.');
          return;
        }
        startQuiz();
      } else {
        startQuiz();
      }
    }

    // Mode H√¥te
    function startHostMode() {
      isHost = true;
      roomId = generateRoomCode();
      playerName = prompt('Votre nom (h√¥te) :') || 'H√¥te';
      playerId = generatePlayerId();
      
      mainMenu.style.display = 'none';
      gameArea.style.display = 'block';
      connectionInfo.style.display = 'block';
      
      // Cr√©er la room dans Firebase
      const roomRef = database.ref('rooms/' + roomId);
      roomRef.set({
        host: playerId,
        state: 'waiting',
        currentQuestion: 0,
        questions: [],
        createdAt: Date.now()
      });
      
      // Ajouter l'h√¥te aux joueurs
      roomRef.child('players/' + playerId).set({
        name: playerName,
        score: 0,
        isHost: true,
        answers: {},
        joinedAt: Date.now()
      });
      
      setupHostInterface();
      listenToRoom();
    }

    // Interface de l'h√¥te
    function setupHostInterface() {
      document.getElementById('roomCode').innerHTML = `
        <div class="waiting-room">
          <h3>üè† Vous √™tes l'h√¥te</h3>
          <div class="room-code-display">${roomId}</div>
          <p>Partagez ce code avec les joueurs !</p>
          <div style="margin: 20px 0;">
            <button onclick="selectQuizType()" style="font-size: 1.2em; padding: 15px 30px; background: #28a745;">
              üìö Choisir le type de quiz
            </button>
            <button onclick="startMultiplayerQuiz()" id="startQuizBtn" style="font-size: 1.2em; padding: 15px 30px; background: #dc3545; display: none;">
              üöÄ D√©marrer le Quiz
            </button>
          </div>
        </div>
      `;
      
      // G√©n√©rer l'URL de partage
      const shareUrl = `${window.location.origin}${window.location.pathname}?join=${roomId}`;
      document.getElementById('qrCode').innerHTML = `
        <div style="text-align: center;">
          <strong>URL √† partager :</strong><br>
          <input type="text" value="${shareUrl}" readonly style="width: 100%; padding: 5px; margin: 5px 0;" onclick="this.select()">
          <br><small>Cliquez pour s√©lectionner et copier</small>
        </div>
      `;
      document.getElementById('qrCode').style.display = 'block';
    }

    // S√©lection du type de quiz par l'h√¥te
    function selectQuizType() {
      const types = Object.keys(questionsBySubject);
      
      questionContainer.innerHTML = `
        <div class="question-card">
          <h3>üéÆ Configuration du Quiz Multijoueur</h3>
          
          <div style="margin: 25px 0;">
            <h4>üìö Domaines √† inclure :</h4>
            <p style="font-size: 0.9em; opacity: 0.8; margin-bottom: 15px;">S√©lectionnez un ou plusieurs domaines</p>
            <div class="quiz-config-grid">
              ${types.map(type => `
                <label class="type-checkbox">
                  <input type="checkbox" value="${type}" onchange="updateTypeSelection()">
                  <span class="type-label">${type}</span>
                  <small class="type-count">(${questionsBySubject[type].length} questions)</small>
                </label>
              `).join('')}
              <label class="type-checkbox special">
                <input type="checkbox" value="all" onchange="selectAllTypes()">
                <span class="type-label">üéØ Tous les domaines</span>
                <small class="type-count">(${Object.values(questionsBySubject).flat().length} questions)</small>
              </label>
            </div>
          </div>
          
          <div style="margin: 25px 0;">
            <h4>üèÜ Format du quiz :</h4>
            <div class="format-options">
              <label class="format-option">
                <input type="radio" name="format" value="series" checked onchange="updateFormatSelection()">
                <div class="format-content">
                  <strong>Mode S√©ries</strong>
                  <p>S√©ries de 5 questions avec classements interm√©diaires</p>
                </div>
              </label>
              <label class="format-option">
                <input type="radio" name="format" value="marathon" onchange="updateFormatSelection()">
                <div class="format-content">
                  <strong>Mode Marathon</strong>
                  <p>Toutes les questions d'affil√©e</p>
                </div>
              </label>
            </div>
          </div>
          
          <div id="seriesConfig" style="margin: 25px 0;">
            <h4>üéØ Nombre de s√©ries :</h4>
            <div class="series-selector">
              ${[1,2,3,4,5,6].map(num => `
                <button class="series-btn ${num === 3 ? 'selected' : ''}" onclick="selectSeriesCount(${num})">${num}</button>
              `).join('')}
            </div>
            <p style="font-size: 0.9em; opacity: 0.8; margin-top: 10px;">
              Chaque s√©rie = 5 questions ‚Ä¢ Total = <span id="totalQuestions">15</span> questions
            </p>
          </div>
          
          <div style="margin: 25px 0;">
            <div id="configSummary" class="config-summary">
              <h4>üìã R√©sum√© de la configuration :</h4>
              <div id="summaryContent">S√©lectionnez au moins un domaine pour commencer</div>
            </div>
          </div>
          
          <div style="text-align: center; margin: 30px 0;">
            <button onclick="generateQuiz()" id="generateQuizBtn" style="display: none; font-size: 1.2em; padding: 15px 30px; background: #28a745;">
              üéØ G√©n√©rer le Quiz
            </button>
          </div>
        </div>
      `;
      

    }

    // Mettre √† jour la s√©lection des types
    function updateTypeSelection() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]:not([value="all"])');
      const allCheckbox = document.querySelector('input[value="all"]');
      
      if (!checkboxes || !allCheckbox) return;
      
      configSelectedTypes = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
      
      // D√©cocher "Tous" si on s√©lectionne individuellement
      if (configSelectedTypes.length > 0) {
        allCheckbox.checked = false;
      }
      
      updateConfigSummary();
    }

    // S√©lectionner tous les types
    function selectAllTypes() {
      const allCheckbox = document.querySelector('input[value="all"]');
      const otherCheckboxes = document.querySelectorAll('input[type="checkbox"]:not([value="all"])');
      
      if (!allCheckbox || !otherCheckboxes) return;
      
      if (allCheckbox.checked) {
        configSelectedTypes = Object.keys(questionsBySubject);
        otherCheckboxes.forEach(cb => cb.checked = true);
      } else {
        configSelectedTypes = [];
        otherCheckboxes.forEach(cb => cb.checked = false);
      }
      
      updateConfigSummary();
    }

    // Mettre √† jour la s√©lection du format
    function updateFormatSelection() {
      const formatRadio = document.querySelector('input[name="format"]:checked');
      if (!formatRadio) return;
      
      const format = formatRadio.value;
      configQuizFormat = format;
      
      const seriesConfig = document.getElementById('seriesConfig');
      if (seriesConfig) {
        seriesConfig.style.display = format === 'series' ? 'block' : 'none';
      }
      
      updateConfigSummary();
    }

    // S√©lectionner le nombre de s√©ries
    function selectSeriesCount(count) {
      configSeriesCount = count;
      
      // Mettre √† jour l'interface
      document.querySelectorAll('.series-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // Trouver et s√©lectionner le bon bouton
      const buttons = document.querySelectorAll('.series-btn');
      buttons.forEach(btn => {
        if (parseInt(btn.textContent) === count) {
          btn.classList.add('selected');
        }
      });
      
      const totalQuestionsElem = document.getElementById('totalQuestions');
      if (totalQuestionsElem) {
        totalQuestionsElem.textContent = count * 5;
      }
      updateConfigSummary();
    }

    // Mettre √† jour le r√©sum√© de configuration
    function updateConfigSummary() {
      const summaryContent = document.getElementById('summaryContent');
      const generateBtn = document.getElementById('generateQuizBtn');
      
      if (!summaryContent || !generateBtn) return;
      
      if (!configSelectedTypes || configSelectedTypes.length === 0) {
        summaryContent.innerHTML = 'S√©lectionnez au moins un domaine pour commencer';
        generateBtn.style.display = 'none';
        return;
      }
      
      const typeNames = configSelectedTypes.join(', ');
      const totalAvailable = configSelectedTypes.reduce((sum, type) => {
        return sum + (questionsBySubject[type] ? questionsBySubject[type].length : 0);
      }, 0);
      
      let summary = `<strong>Domaines :</strong> ${typeNames}<br>`;
      summary += `<strong>Questions disponibles :</strong> ${totalAvailable}<br>`;
      
      if (configQuizFormat === 'series') {
        summary += `<strong>Format :</strong> ${configSeriesCount} s√©ries de 5 questions (${configSeriesCount * 5} total)<br>`;
        summary += `<strong>Classements :</strong> Apr√®s chaque s√©rie + final`;
      } else {
        summary += `<strong>Format :</strong> Marathon (toutes les questions d'affil√©e)<br>`;
        summary += `<strong>Total :</strong> ${Math.min(totalAvailable, 50)} questions`;
      }
      
      summaryContent.innerHTML = summary;
      generateBtn.style.display = 'inline-block';
    }

    // G√©n√©rer le quiz avec la configuration
    function generateQuiz() {
      if (!configSelectedTypes || configSelectedTypes.length === 0) {
        alert('Veuillez s√©lectionner au moins un domaine !');
        return;
      }
      
      // Collecter toutes les questions des types s√©lectionn√©s
      let allSelectedQuestions = [];
      configSelectedTypes.forEach(type => {
        if (questionsBySubject[type]) {
          allSelectedQuestions.push(...questionsBySubject[type]);
        }
      });
      
      // M√©langer et s√©lectionner les questions
      allSelectedQuestions = shuffleArray(allSelectedQuestions);
      
      let finalQuestions = [];
      if (configQuizFormat === 'series') {
        const questionsNeeded = configSeriesCount * 5;
        finalQuestions = allSelectedQuestions.slice(0, questionsNeeded);
      } else {
        finalQuestions = allSelectedQuestions.slice(0, Math.min(50, allSelectedQuestions.length));
      }
      
      if (finalQuestions.length === 0) {
        alert('Aucune question disponible pour cette configuration !');
        return;
      }
      
      // Sauvegarder la configuration dans Firebase
      database.ref('rooms/' + roomId).update({
        questions: finalQuestions,
        selectedTypes: configSelectedTypes,
        quizFormat: configQuizFormat,
        seriesCount: configQuizFormat === 'series' ? configSeriesCount : 1,
        currentSeries: 0,
        seriesScores: {}
      });
      
      const startBtn = document.getElementById('startQuizBtn');
      if (startBtn) {
        startBtn.style.display = 'inline-block';
      }
      
      questionContainer.innerHTML = `
        <div class="question-card">
          <h3>‚úÖ Quiz configur√© avec succ√®s !</h3>
          <div class="final-config">
            <div class="config-item">
              <strong>üìö Domaines :</strong> ${configSelectedTypes.join(', ')}
            </div>
            <div class="config-item">
              <strong>üéØ Format :</strong> ${configQuizFormat === 'series' ? `${configSeriesCount} s√©ries de 5 questions` : 'Mode marathon'}
            </div>
            <div class="config-item">
              <strong>‚ùì Total :</strong> ${finalQuestions.length} questions
            </div>
          </div>
          <p style="margin: 20px 0; padding: 15px; background: rgba(40,167,69,0.1); border-radius: 10px; color: #28a745;">
            üéÆ Le quiz est pr√™t ! Cliquez sur "D√©marrer le Quiz" quand tous les joueurs sont connect√©s.
          </p>
        </div>
      `;
    }

    // Mode Rejoindre
    function startJoinMode() {
      const urlParams = new URLSearchParams(window.location.search);
      const joinCode = urlParams.get('join') || prompt('Entrez le code de la partie :');
      
      if (!joinCode) return;
      
      roomId = joinCode.toUpperCase();
      playerName = prompt('Votre nom :') || 'Joueur';
      playerId = generatePlayerId();
      
      // V√©rifier si la room existe
      database.ref('rooms/' + roomId).once('value', (snapshot) => {
        if (!snapshot.exists()) {
          alert('Cette partie n\'existe pas !');
          return;
        }
        
        mainMenu.style.display = 'none';
        gameArea.style.display = 'block';
        connectionInfo.style.display = 'block';
        
        // Rejoindre la room
        database.ref('rooms/' + roomId + '/players/' + playerId).set({
          name: playerName,
          score: 0,
          isHost: false,
          answers: {},
          joinedAt: Date.now()
        });
        
        setupPlayerInterface();
        listenToRoom();
      });
    }

    // Interface du joueur
    function setupPlayerInterface() {
      document.getElementById('roomCode').innerHTML = `
        <div class="waiting-room">
          <h3>üì± Connect√© √† la partie</h3>
          <div class="room-code-display">${roomId}</div>
          <p>‚úÖ Vous √™tes connect√© en tant que <strong>${playerName}</strong></p>
          <p>En attente de l'h√¥te...</p>
        </div>
      `;
    }

    // √âcouter les changements de la room
    function listenToRoom() {
      const roomRef = database.ref('rooms/' + roomId);
      
      // √âcouter les joueurs
      roomRef.child('players').on('value', (snapshot) => {
        players = snapshot.val() || {};
        updatePlayersList();
      });
      
      // √âcouter l'√©tat du jeu
      roomRef.child('state').on('value', (snapshot) => {
        gameState = snapshot.val();
        if (gameState === 'playing' && !isHost) {
          startMultiplayerQuiz();
        }
      });
      
      // √âcouter la question actuelle
      roomRef.child('currentQuestion').on('value', (snapshot) => {
        const questionIndex = snapshot.val();
        if (gameState === 'playing' && questionIndex !== currentQuestionIndex) {
          currentQuestionIndex = questionIndex;
          if (!isHost) {
            if (currentQuestionIndex >= questions.length) {
              showPlayerWaiting();
            } else {
              showCurrentQuestion();
            }
          }
        }
      });
      
      // √âcouter les changements de s√©rie
      roomRef.child('currentSeries').on('value', (snapshot) => {
        const seriesNumber = snapshot.val();
        if (seriesNumber !== undefined) {
          // Mettre √† jour la s√©rie actuelle
        }
      });
    }
    }

    // Mettre √† jour la liste des joueurs
    function updatePlayersList() {
      const playersList = Object.values(players);
      const html = `
        <div class="players-list">
          <h4>üë• Joueurs connect√©s (${playersList.length})</h4>
          ${playersList.map(player => `
            <div class="player-item">
              <span class="player-name">${player.isHost ? 'üëë ' : ''}${player.name}</span>
              <span class="player-score">${player.score || 0} pts</span>
            </div>
          `).join('')}
        </div>
      `;
      document.getElementById('playersList').innerHTML = html;
    }

    // D√©marrer le quiz multijoueur
    function startMultiplayerQuiz() {
      if (isHost) {
        // L'h√¥te d√©marre le quiz
        database.ref('rooms/' + roomId + '/state').set('playing');
        database.ref('rooms/' + roomId + '/currentQuestion').set(0);
        database.ref('rooms/' + roomId + '/currentSeries').set(0);
        
        // R√©cup√©rer la configuration et les questions
        database.ref('rooms/' + roomId).once('value', (snapshot) => {
          const roomData = snapshot.val();
          questions = roomData.questions || [];
          configQuizFormat = roomData.quizFormat || 'series';
          configSeriesCount = roomData.seriesCount || 1;
          
          currentQuestionIndex = 0;
          score = 0;
          startTime = Date.now();
          showHostQuestion();
        });
      } else {
        // Le joueur commence √† jouer
        database.ref('rooms/' + roomId).once('value', (snapshot) => {
          const roomData = snapshot.val();
          questions = roomData.questions || [];
          configQuizFormat = roomData.quizFormat || 'series';
          configSeriesCount = roomData.seriesCount || 1;
          
          currentQuestionIndex = 0;
          score = 0;
          startTime = Date.now();
          showCurrentQuestion();
        });
      }
      
      document.getElementById('qrCode').style.display = 'none';
    }

    // Afficher la question pour l'h√¥te
    function showHostQuestion() {
      // V√©rifier si on doit afficher un classement de s√©rie
      if (configQuizFormat === 'series' && currentQuestionIndex > 0 && currentQuestionIndex % 5 === 0) {
        const serieNumber = Math.floor(currentQuestionIndex / 5);
        if (serieNumber <= configSeriesCount) {
          showSeriesResults(serieNumber);
          return;
        }
      }
      
      if (currentQuestionIndex >= questions.length) {
        showMultiplayerResults();
        return;
      }
      
      const question = questions[currentQuestionIndex];
      const currentSeriesNum = configQuizFormat === 'series' ? Math.floor(currentQuestionIndex / 5) + 1 : 1;
      const questionInSeries = configQuizFormat === 'series' ? (currentQuestionIndex % 5) + 1 : currentQuestionIndex + 1;
      
      // √âcouter les r√©ponses des joueurs
      listenToPlayerAnswers();
      
      const html = `
        <div class="question-card">
          <div class="question-header">
            <div class="question-type">${question.type}</div>
            <div>üëë ${configQuizFormat === 'series' ? `S√©rie ${currentSeriesNum} - Question ${questionInSeries}/5` : `Question ${currentQuestionIndex + 1}/${questions.length}`}</div>
          </div>
          <div class="question-title">${question.title}</div>
          <div class="choices">
            ${question.choices.map((choice, i) => `
              <div class="choice" data-choice="${i}" style="cursor: default;">
                ${choice}
              </div>
            `).join('')}
          </div>
          <div id="answerStatus" style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
            <h4>üìä √âtat des r√©ponses :</h4>
            <div id="playerAnswerStatus"></div>
            <div style="margin: 10px 0;">
              <strong>‚è±Ô∏è Temps restant : <span id="hostTimer">30s</span></strong>
            </div>
          </div>
          <div id="resultsSection" style="display: none;">
            <div style="margin: 20px 0; padding: 15px; background: rgba(0,200,0,0.1); border-radius: 10px;">
              <h4>‚úÖ R√©ponses correctes :</h4>
              ${question.choices.map((choice, i) => `
                <div style="margin: 8px 0; padding: 10px; background: ${question.answer.includes(i) ? '#c8e6c9' : '#f5f5f5'}; border-radius: 5px;">
                  ${question.answer.includes(i) ? '‚úÖ' : '‚óØ'} ${choice}
                </div>
              `).join('')}
            </div>
            <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 10px; color: #856404;">
              ${question.explanation}
            </div>
            <div id="answerStats" style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;"></div>
          </div>
          <div style="text-align: center; margin: 20px 0;">
            <button onclick="showHostResults()" id="showResultsBtn" style="font-size: 1.2em; padding: 15px 30px; background: #28a745; display: none;">
              üìä Afficher les r√©sultats
            </button>
            <button onclick="nextMultiplayerQuestion()" id="nextQuestionBtn" style="font-size: 1.2em; padding: 15px 30px; background: #17a2b8; display: none;">
              ‚û°Ô∏è ${configQuizFormat === 'series' && questionInSeries === 5 ? 'Voir le classement' : 'Question suivante'}
            </button>
            <button onclick="endMultiplayerQuiz()" style="font-size: 1.2em; padding: 15px 30px; background: #dc3545;">
              üèÅ Terminer le quiz
            </button>
          </div>
        </div>
      `;
      
      questionContainer.innerHTML = html;
      updateScore();
      updateProgress();
      
      // D√©marrer le timer de l'h√¥te
      startHostTimer();
    }

    // √âcouter les r√©ponses des joueurs (h√¥te)
    function listenToPlayerAnswers() {
      const playersRef = database.ref('rooms/' + roomId + '/players');
      
      playersRef.on('value', (snapshot) => {
        const allPlayers = snapshot.val() || {};
        const playersList = Object.values(allPlayers);
        const totalPlayers = playersList.length;
        const answeredPlayers = playersList.filter(player => 
          player.answers && player.answers[currentQuestionIndex]
        ).length;
        
        // Mettre √† jour le statut des r√©ponses
        document.getElementById('playerAnswerStatus').innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
            <span><strong>${answeredPlayers}/${totalPlayers}</strong> joueurs ont r√©pondu</span>
            <div style="background: rgba(255,255,255,0.2); border-radius: 10px; padding: 5px 10px;">
              ${Math.round((answeredPlayers/totalPlayers)*100)}%
            </div>
          </div>
          <div style="margin: 10px 0;">
            ${playersList.map(player => {
              const hasAnswered = player.answers && player.answers[currentQuestionIndex];
              return `
                <span style="display: inline-block; margin: 3px; padding: 5px 10px; border-radius: 15px; background: ${hasAnswered ? '#28a745' : '#6c757d'}; color: white; font-size: 0.9em;">
                  ${hasAnswered ? '‚úÖ' : '‚è≥'} ${player.name}
                </span>
              `;
            }).join('')}
          </div>
        `;
        
        // Afficher le bouton de r√©sultats si tous ont r√©pondu ou si le temps est √©coul√©
        if (answeredPlayers === totalPlayers && totalPlayers > 0) {
          document.getElementById('showResultsBtn').style.display = 'inline-block';
          document.getElementById('hostTimer').parentElement.innerHTML = '<strong>‚úÖ Tous les joueurs ont r√©pondu !</strong>';
        }
      });
    }

    // Timer de l'h√¥te
    function startHostTimer() {
      let timeLeft = 30;
      const timerElement = document.getElementById('hostTimer');
      
      const hostTimer = setInterval(() => {
        timeLeft--;
        timerElement.textContent = `${timeLeft}s`;
        
        if (timeLeft <= 10) {
          timerElement.style.color = '#e17055';
        }
        
        if (timeLeft <= 0) {
          clearInterval(hostTimer);
          timerElement.parentElement.innerHTML = '<strong>‚è∞ Temps √©coul√© !</strong>';
          document.getElementById('showResultsBtn').style.display = 'inline-block';
        }
      }, 1000);
    }

    // Afficher les r√©sultats (h√¥te)
    function showHostResults() {
      const question = questions[currentQuestionIndex];
      
      // R√©cup√©rer les statistiques des r√©ponses
      database.ref('rooms/' + roomId + '/players').once('value', (snapshot) => {
        const allPlayers = snapshot.val() || {};
        const playersList = Object.values(allPlayers);
        const stats = {};
        let correctCount = 0;
        
        // Calculer les statistiques
        question.choices.forEach((choice, index) => {
          stats[index] = { count: 0, players: [] };
        });
        
        playersList.forEach(player => {
          if (player.answers && player.answers[currentQuestionIndex]) {
            const answer = player.answers[currentQuestionIndex];
            answer.choices.forEach(choiceIndex => {
              stats[choiceIndex].count++;
              stats[choiceIndex].players.push(player.name);
            });
            if (answer.correct) correctCount++;
          }
        });
        
        // Afficher les r√©sultats
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('showResultsBtn').style.display = 'none';
        document.getElementById('nextQuestionBtn').style.display = 'inline-block';
        
        // Mettre √† jour les choix avec les statistiques
        const choicesContainer = document.querySelector('.choices');
        choicesContainer.innerHTML = question.choices.map((choice, i) => {
          const isCorrect = question.answer.includes(i);
          const count = stats[i].count;
          const percentage = playersList.length > 0 ? Math.round((count / playersList.length) * 100) : 0;
          
          return `
            <div class="choice ${isCorrect ? 'correct' : ''}" style="position: relative; cursor: default;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>${choice}</span>
                <span style="background: rgba(0,0,0,0.1); padding: 3px 8px; border-radius: 10px; font-size: 0.9em;">
                  ${count} (${percentage}%)
                </span>
              </div>
              ${count > 0 ? `
                <div style="margin-top: 5px; font-size: 0.8em; opacity: 0.8;">
                  üë• ${stats[i].players.join(', ')}
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
        
        // Afficher les statistiques g√©n√©rales
        document.getElementById('answerStats').innerHTML = `
          <h4>üìä Statistiques de la question :</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 15px 0;">
            <div style="text-align: center; padding: 10px; background: rgba(40, 167, 69, 0.2); border-radius: 10px;">
              <div style="font-size: 1.5em; font-weight: bold; color: #28a745;">${correctCount}</div>
              <div>R√©ponses correctes</div>
            </div>
            <div style="text-align: center; padding: 10px; background: rgba(220, 53, 69, 0.2); border-radius: 10px;">
              <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;">${playersList.length - correctCount}</div>
              <div>R√©ponses incorrectes</div>
            </div>
            <div style="text-align: center; padding: 10px; background: rgba(23, 162, 184, 0.2); border-radius: 10px;">
              <div style="font-size: 1.5em; font-weight: bold; color: #17a2b8;">${Math.round((correctCount/playersList.length)*100)}%</div>
              <div>Taux de r√©ussite</div>
            </div>
          </div>
        `;
      });
    }

    // Question suivante (multijoueur)
    function nextMultiplayerQuestion() {
      currentQuestionIndex++;
      database.ref('rooms/' + roomId + '/currentQuestion').set(currentQuestionIndex);
      showHostQuestion();
    }

    // √âcran d'attente pour les joueurs
    function showPlayerWaiting() {
      questionContainer.innerHTML = `
        <div class="waiting-room">
          <h3>‚è≥ En attente...</h3>
          <p>L'h√¥te pr√©pare la suite du quiz</p>
          <div style="margin: 20px 0;">
            <div style="font-size: 1.2em;">Votre score actuel : <strong>${score} points</strong></div>
          </div>
        </div>
      `;
    }

    // Terminer le quiz (multijoueur)
    function endMultiplayerQuiz() {
      database.ref('rooms/' + roomId + '/state').set('finished');
      showMultiplayerResults();
    }

    // Afficher la question pour les joueurs
    function showCurrentQuestion() {
      if (currentQuestionIndex >= questions.length || gameState === 'finished') {
        showPlayerWaiting();
        return;
      }
      
      const question = questions[currentQuestionIndex];
      const currentSeriesNum = configQuizFormat === 'series' ? Math.floor(currentQuestionIndex / 5) + 1 : 1;
      const questionInSeries = configQuizFormat === 'series' ? (currentQuestionIndex % 5) + 1 : currentQuestionIndex + 1;
      
      hasAnswered = false;
      selectedChoices = [];
      
      // Interface simplifi√©e pour les joueurs (t√©l√©commande)
      const html = `
        <div class="question-card">
          <div class="question-header">
            <div class="question-type">${question.type}</div>
            <div>üì± ${configQuizFormat === 'series' ? `S√©rie ${currentSeriesNum} - Q${questionInSeries}/5` : `Question ${currentQuestionIndex + 1}/${questions.length}`}</div>
          </div>
          <div class="question-title">${question.title}</div>
          <div class="choices">
            ${question.choices.map((choice, i) => `
              <div class="choice" onclick="selectChoice(${i})" data-choice="${i}">
                ${choice}
              </div>
            `).join('')}
          </div>
          <div id="playerStatus" style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; text-align: center;">
            <p>S√©lectionnez votre/vos r√©ponse(s) et validez</p>
            ${configQuizFormat === 'series' ? `<small>S√©rie ${currentSeriesNum} sur ${configSeriesCount} ‚Ä¢ Score actuel : ${score} pts</small>` : `<small>Score actuel : ${score} pts</small>`}
          </div>
          <div style="text-align: center;">
            <button onclick="submitMultiplayerAnswer()" id="submitBtn" style="font-size: 1.3em; padding: 15px 40px;">
              üìù Envoyer ma r√©ponse
            </button>
          </div>
        </div>
      `;
      
      questionContainer.innerHTML = html;
      updateScore();
      updateProgress();
    }

    // Soumettre une r√©ponse (multijoueur)
    function submitMultiplayerAnswer() {
      if (hasAnswered || selectedChoices.length === 0) {
        if (selectedChoices.length === 0) {
          alert('Veuillez s√©lectionner au moins une r√©ponse !');
        }
        return;
      }
      
      hasAnswered = true;
      const currentQuestion = questions[currentQuestionIndex];
      
      // V√©rifier la r√©ponse
      const isCorrect = JSON.stringify(selectedChoices.sort()) === JSON.stringify(currentQuestion.answer.sort());
      if (isCorrect) {
        score++;
      }
      
      // Sauvegarder la r√©ponse dans Firebase
      database.ref('rooms/' + roomId + '/players/' + playerId + '/answers/' + currentQuestionIndex).set({
        choices: selectedChoices,
        correct: isCorrect,
        timestamp: Date.now()
      });
      
      database.ref('rooms/' + roomId + '/players/' + playerId + '/score').set(score);
      
      updateScore();
      
      // Interface simple de confirmation pour le joueur
      document.getElementById('playerStatus').innerHTML = `
        <div style="background: var(--color-success); color: white; padding: 15px; border-radius: 10px;">
          ‚úÖ <strong>R√©ponse envoy√©e !</strong><br>
          <small>Attendez que l'h√¥te affiche les r√©sultats sur l'√©cran principal</small>
        </div>
      `;
      
      // Masquer le bouton et d√©sactiver les choix
      document.getElementById('submitBtn').style.display = 'none';
      document.querySelectorAll('.choice').forEach(choice => {
        choice.style.pointerEvents = 'none';
        choice.style.opacity = '0.6';
      });
    }

    // R√©sultats multijoueur
    function showMultiplayerResults() {
      clearInterval(timer);
      
      if (isHost) {
        // Vue h√¥te - classement + r√©capitulatif complet
        const playersList = Object.values(players).sort((a, b) => (b.score || 0) - (a.score || 0));
        
        const html = `
          <div class="final-results">
            <h2>üèÜ R√©sultats finaux !</h2>
            
            <!-- Onglets de navigation -->
            <div class="results-tabs">
              <button class="tab-btn active" onclick="showResultsTab('ranking', this)">üèÜ Classement</button>
              <button class="tab-btn" onclick="showResultsTab('review', this)">üìö R√©capitulatif</button>
              <button class="tab-btn" onclick="showResultsTab('stats', this)">üìä Statistiques</button>
            </div>
            
            <!-- Onglet Classement -->
            <div id="rankingTab" class="tab-content active">
              <div style="margin: 30px 0;">
                ${playersList.map((player, index) => {
                  const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
                  const percentage = Math.round(((player.score || 0) / questions.length) * 100);
                  return `
                    <div class="player-item" style="background: ${index < 3 ? 'rgba(255,215,0,0.2)' : 'rgba(255,255,255,0.1)'}; margin: 10px 0; font-size: 1.2em;">
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${medal} ${player.isHost ? 'üëë ' : ''}${player.name}</span>
                        <div style="text-align: right;">
                          <span class="player-score">${player.score || 0}/${questions.length}</span>
                          <br><small>${percentage}%</small>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            
            <!-- Onglet R√©capitulatif -->
            <div id="reviewTab" class="tab-content">
              <div style="margin: 20px 0;">
                <h3>üìö Toutes les questions pos√©es</h3>
                <p style="opacity: 0.8; margin-bottom: 20px;">Cliquez sur une question pour voir les d√©tails et statistiques</p>
                <div id="questionsReview">
                  ${questions.map((question, index) => `
                    <div class="question-summary" onclick="toggleQuestionDetails(${index})">
                      <div class="question-summary-header">
                        <span class="question-number">Q${index + 1}</span>
                        <span class="question-type-small">${question.type}</span>
                        <span class="question-title-small">${question.title}</span>
                        <span class="expand-icon">‚ñº</span>
                      </div>
                      <div class="question-details" id="details${index}" style="display: none;">
                        <div class="question-choices-review">
                          ${question.choices.map((choice, i) => `
                            <div class="choice-review ${question.answer.includes(i) ? 'correct' : ''}">
                              ${question.answer.includes(i) ? '‚úÖ' : '‚óØ'} ${choice}
                            </div>
                          `).join('')}
                        </div>
                        <div class="explanation-review">
                          ${question.explanation}
                        </div>
                        <div class="question-stats" id="questionStats${index}">
                          <em>Chargement des statistiques...</em>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
            
            <!-- Onglet Statistiques -->
            <div id="statsTab" class="tab-content">
              <div style="margin: 20px 0;">
                <h3>üìä Statistiques g√©n√©rales</h3>
                <div class="stats-grid">
                  <div class="stat-card">
                    <h3>${questions.length}</h3>
                    <p>Questions pos√©es</p>
                  </div>
                  <div class="stat-card">
                    <h3>${playersList.length}</h3>
                    <p>Participants</p>
                  </div>
                  <div class="stat-card">
                    <h3>${Math.round(playersList.reduce((sum, p) => sum + (p.score || 0), 0) / playersList.length * 100 / questions.length)}%</h3>
                    <p>Taux moyen de r√©ussite</p>
                  </div>
                  <div class="stat-card">
                    <h3>${configQuizFormat === 'series' ? configSeriesCount : 1}</h3>
                    <p>${configQuizFormat === 'series' ? 'S√©ries jou√©es' : 'Quiz marathon'}</p>
                  </div>
                </div>
                <div id="detailedStats" style="margin: 30px 0;">
                  <h4>üìà Questions les plus difficiles :</h4>
                  <div id="difficultQuestions">Calcul en cours...</div>
                </div>
              </div>
            </div>
            
            <div style="margin-top: 30px; text-align: center;">
              <button onclick="goHome()" style="font-size: 1.2em; padding: 15px 30px; background: #6c757d;">
                üè† Menu principal
              </button>
              <button onclick="exportResults()" style="font-size: 1.2em; padding: 15px 30px; background: #17a2b8;">
                üìÑ Exporter les r√©sultats
              </button>
            </div>
          </div>
        `;
        
        questionContainer.innerHTML = html;
        
        // Charger les statistiques d√©taill√©es
        loadDetailedStats();
        
      } else {
        // Vue joueur - score personnel simplifi√©
        const percentage = Math.round((score / questions.length) * 100);
        
        let performance = '';
        if (percentage >= 80) performance = 'üèÜ Excellent !';
        else if (percentage >= 60) performance = 'üëè Bien jou√© !';
        else if (percentage >= 40) performance = 'üìö √Ä retravailler';
        else performance = 'üí™ Continuez vos efforts !';
        
        const html = `
          <div class="final-results">
            <h2>üéØ Votre r√©sultat !</h2>
            <div style="font-size: 2em; margin: 20px 0;">
              ${score}/${questions.length}
            </div>
            <div style="font-size: 1.5em; margin: 15px 0;">
              ${percentage}% de r√©ussite
            </div>
            <div style="font-size: 1.3em; margin: 15px 0;">
              ${performance}
            </div>
            <p style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
              üí° L'h√¥te va afficher le r√©capitulatif complet des questions sur l'√©cran principal pour la discussion.
            </p>
            <button onclick="goHome()" style="font-size: 1.2em; padding: 15px 30px; background: #6c757d;">
              üè† Menu principal
            </button>
          </div>
        `;
        
        questionContainer.innerHTML = html;
      }
    }

    // Basculer entre les onglets de r√©sultats
    function showResultsTab(tabName, clickedElement) {
      // Masquer tous les onglets
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Afficher l'onglet s√©lectionn√©
      const targetTab = document.getElementById(tabName + 'Tab');
      if (targetTab) {
        targetTab.classList.add('active');
      }
      
      if (clickedElement) {
        clickedElement.classList.add('active');
      }
    }

    // Basculer les d√©tails d'une question
    function toggleQuestionDetails(questionIndex) {
      const details = document.getElementById(`details${questionIndex}`);
      if (!details) return;
      
      const summary = details.previousElementSibling;
      const icon = summary ? summary.querySelector('.expand-icon') : null;
      
      if (details.style.display === 'none' || details.style.display === '') {
        details.style.display = 'block';
        if (icon) icon.textContent = '‚ñ≤';
        
        // Charger les statistiques de cette question
        loadQuestionStats(questionIndex);
      } else {
        details.style.display = 'none';
        if (icon) icon.textContent = '‚ñº';
      }
    }

    // Charger les statistiques d'une question sp√©cifique
    function loadQuestionStats(questionIndex) {
      database.ref('rooms/' + roomId + '/players').once('value', (snapshot) => {
        const allPlayers = snapshot.val() || {};
        const playersList = Object.values(allPlayers);
        const question = questions[questionIndex];
        
        const stats = {};
        let correctCount = 0;
        let totalAnswers = 0;
        
        // Initialiser les statistiques
        question.choices.forEach((choice, index) => {
          stats[index] = { count: 0, players: [] };
        });
        
        // Calculer les statistiques
        playersList.forEach(player => {
          if (player.answers && player.answers[questionIndex]) {
            totalAnswers++;
            const answer = player.answers[questionIndex];
            answer.choices.forEach(choiceIndex => {
              stats[choiceIndex].count++;
              stats[choiceIndex].players.push(player.name);
            });
            if (answer.correct) correctCount++;
          }
        });
        
        const successRate = totalAnswers > 0 ? Math.round((correctCount / totalAnswers) * 100) : 0;
        
        // Afficher les statistiques
        document.getElementById(`questionStats${questionIndex}`).innerHTML = `
          <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
            <h5>üìä Statistiques de cette question :</h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 10px 0;">
              <div style="text-align: center; padding: 8px; background: rgba(40, 167, 69, 0.2); border-radius: 5px;">
                <strong style="color: #28a745;">${correctCount}/${totalAnswers}</strong><br>
                <small>Bonnes r√©ponses</small>
              </div>
              <div style="text-align: center; padding: 8px; background: rgba(23, 162, 184, 0.2); border-radius: 5px;">
                <strong style="color: #17a2b8;">${successRate}%</strong><br>
                <small>Taux de r√©ussite</small>
              </div>
            </div>
            <div style="margin: 10px 0;">
              <strong>R√©partition des r√©ponses :</strong>
              ${question.choices.map((choice, i) => {
                const count = stats[i].count;
                const percentage = totalAnswers > 0 ? Math.round((count / totalAnswers) * 100) : 0;
                return `
                  <div style="margin: 5px 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                    <div style="display: flex; justify-content: space-between;">
                      <span>${question.answer.includes(i) ? '‚úÖ' : '‚ùå'} ${choice}</span>
                      <span><strong>${count}</strong> (${percentage}%)</span>
                    </div>
                    ${count > 0 ? `<small style="opacity: 0.8;">üë• ${stats[i].players.join(', ')}</small>` : ''}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      });
    }

    // Charger les statistiques d√©taill√©es
    function loadDetailedStats() {
      database.ref('rooms/' + roomId + '/players').once('value', (snapshot) => {
        const allPlayers = snapshot.val() || {};
        const playersList = Object.values(allPlayers);
        
        // Calculer les questions les plus difficiles
        const questionDifficulty = questions.map((question, index) => {
          let correctCount = 0;
          let totalAnswers = 0;
          
          playersList.forEach(player => {
            if (player.answers && player.answers[index]) {
              totalAnswers++;
              if (player.answers[index].correct) correctCount++;
            }
          });
          
          const successRate = totalAnswers > 0 ? (correctCount / totalAnswers) * 100 : 0;
          return {
            index: index + 1,
            title: question.title,
            type: question.type,
            successRate: Math.round(successRate),
            correctCount,
            totalAnswers
          };
        }).sort((a, b) => a.successRate - b.successRate);
        
        // Afficher les questions les plus difficiles
        document.getElementById('difficultQuestions').innerHTML = `
          <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
            ${questionDifficulty.slice(0, 5).map((q, index) => `
              <div style="margin: 10px 0; padding: 10px; background: rgba(220, 53, 69, 0.1); border-radius: 5px; border-left: 3px solid #dc3545;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>Q${q.index}</strong> - ${q.type}<br>
                    <small>${q.title.substring(0, 60)}${q.title.length > 60 ? '...' : ''}</small>
                  </div>
                  <div style="text-align: right;">
                    <strong style="color: #dc3545;">${q.successRate}%</strong><br>
                    <small>${q.correctCount}/${q.totalAnswers}</small>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      });
    }

    // Exporter les r√©sultats
    function exportResults() {
      try {
        const playersList = Object.values(players).sort((a, b) => (b.score || 0) - (a.score || 0));
        
        let exportText = `üèÜ R√âSULTATS DU QUIZ DWWM\n`;
        exportText += `================================\n\n`;
        exportText += `üìä INFORMATIONS G√âN√âRALES\n`;
        exportText += `- Questions pos√©es : ${questions.length}\n`;
        exportText += `- Participants : ${playersList.length}\n`;
        exportText += `- Format : ${configQuizFormat === 'series' ? `${configSeriesCount} s√©ries de 5 questions` : 'Mode marathon'}\n`;
        exportText += `- Domaines : ${configSelectedTypes && configSelectedTypes.length > 0 ? configSelectedTypes.join(', ') : 'Mixte'}\n`;
        exportText += `- Date : ${new Date().toLocaleDateString('fr-FR')}\n\n`;
        
        exportText += `üèÜ CLASSEMENT FINAL\n`;
        exportText += `==================\n`;
        playersList.forEach((player, index) => {
          const percentage = Math.round(((player.score || 0) / questions.length) * 100);
          exportText += `${index + 1}. ${player.isHost ? 'üëë ' : ''}${player.name} - ${player.score || 0}/${questions.length} (${percentage}%)\n`;
        });
        
        exportText += `\nüìö R√âCAPITULATIF DES QUESTIONS\n`;
        exportText += `==============================\n`;
        questions.forEach((question, index) => {
          exportText += `\nQ${index + 1} [${question.type}] ${question.title}\n`;
          question.choices.forEach((choice, i) => {
            exportText += `${question.answer.includes(i) ? '‚úÖ' : '  '} ${choice}\n`;
          });
          // Retirer les balises HTML de l'explication
          const cleanExplanation = question.explanation.replace(/<[^>]*>/g, '').replace(/&[^;]+;/g, ' ');
          exportText += `üí° ${cleanExplanation}\n`;
        });
        
        // Cr√©er et t√©l√©charger le fichier
        const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `quiz-dwwm-resultats-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        alert('üìÑ R√©sultats export√©s avec succ√®s !');
      } catch (error) {
        console.error('Erreur lors de l\'export:', error);
        alert('‚ùå Erreur lors de l\'export. V√©rifiez la console pour plus de d√©tails.');
      }
    }

    // Fonctions utilitaires
    function generateRoomCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }
    
    function generatePlayerId() {
      return Math.random().toString(36).substring(2, 15);
    }

    // === FONCTIONS SOLO (inchang√©es) ===
    
    // Afficher le s√©lecteur de type
    function showTypeSelector() {
      typeSelector.style.display = 'block';
      const types = Object.keys(questionsBySubject);
      
      typeButtons.innerHTML = types.map(type => 
        `<span class="type-btn" onclick="selectType('${type}')">${type}</span>`
      ).join('');
      
      document.getElementById('startBtn').style.display = 'block';
    }

    // S√©lectionner un type
    function selectType(type) {
      selectedType = type;
      document.querySelectorAll('.type-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.textContent === type) {
          btn.classList.add('selected');
        }
      });
    }

    // D√©marrer le mode s√©lectionn√©
    function startSelectedMode() {
      if (!selectedType && (currentMode === 'typetest' || currentMode === 'fulltypetest')) {
        alert('Veuillez s√©lectionner un domaine !');
        return;
      }
      startQuiz();
    }

    // D√©marrer le quiz (solo)
    function startQuiz() {
      mainMenu.style.display = 'none';
      gameArea.style.display = 'block';
      
      const allQuestions = Object.values(questionsBySubject).flat();
      
      switch (currentMode) {
        case 'selftest':
          questions = shuffleArray([...allQuestions]).slice(0, 10);
          break;
        case 'onepertype':
          questions = getOnePerType(allQuestions);
          break;
        case 'typetest':
          const typeQuestions = questionsBySubject[selectedType] || [];
          questions = shuffleArray([...typeQuestions]).slice(0, 8);
          break;
        case 'fulltypetest':
          questions = [...(questionsBySubject[selectedType] || [])];
          break;
        case 'review':
          questions = [...missedQuestions];
          break;
        case 'fulltest':
          questions = shuffleArray([...allQuestions]);
          break;
      }
      
      if (questions.length === 0) {
        alert('Aucune question disponible pour ce mode !');
        goHome();
        return;
      }
      
      currentQuestionIndex = 0;
      score = 0;
      startTime = Date.now();
      showQuestion();
    }

    // Obtenir une question par type
    function getOnePerType(allQuestions) {
      const types = Object.keys(questionsBySubject);
      const result = [];
      
      types.forEach(type => {
        const typeQuestions = questionsBySubject[type];
        if (typeQuestions.length > 0) {
          const randomQuestion = typeQuestions[Math.floor(Math.random() * typeQuestions.length)];
          result.push(randomQuestion);
        }
      });
      
      return shuffleArray(result);
    }

    // Afficher une question (solo)
    function showQuestion() {
      if (currentQuestionIndex >= questions.length) {
        showFinalResults();
        return;
      }
      
      const question = questions[currentQuestionIndex];
      hasAnswered = false;
      selectedChoices = [];
      
      // D√©marrer le timer
      timeLeft = 30;
      startTimer();
      
      const html = `
        <div class="question-card">
          <div class="question-header">
            <div class="question-type">${question.type}</div>
            <div>Question ${currentQuestionIndex + 1}/${questions.length}</div>
          </div>
          <div class="question-title">${question.title}</div>
          <div class="choices">
            ${question.choices.map((choice, i) => `
              <div class="choice" onclick="selectChoice(${i})" data-choice="${i}">
                ${choice}
              </div>
            `).join('')}
          </div>
          <div class="explanation" id="explanation">
            ${question.explanation}
          </div>
          <button onclick="submitAnswer()" id="submitBtn">üìù Valider ma r√©ponse</button>
          <button onclick="nextQuestion()" id="nextBtn" style="display:none;">‚û°Ô∏è Question suivante</button>
        </div>
      `;
      
      questionContainer.innerHTML = html;
      updateScore();
      updateProgress();
    }

    // S√©lectionner une r√©ponse
    function selectChoice(choiceIndex) {
      if (hasAnswered) return;
      
      const choice = document.querySelector(`[data-choice="${choiceIndex}"]`);
      
      if (choice.classList.contains('selected')) {
        choice.classList.remove('selected');
        selectedChoices = selectedChoices.filter(i => i !== choiceIndex);
      } else {
        choice.classList.add('selected');
        selectedChoices.push(choiceIndex);
      }
    }

    // Soumettre la r√©ponse (solo)
    function submitAnswer() {
      if (hasAnswered || selectedChoices.length === 0) {
        if (selectedChoices.length === 0) {
          alert('Veuillez s√©lectionner au moins une r√©ponse !');
        }
        return;
      }
      
      hasAnswered = true;
      const currentQuestion = questions[currentQuestionIndex];
      
      // Arr√™ter le timer
      clearInterval(timer);
      timerDisplay.textContent = '';
      
      // V√©rifier la r√©ponse
      const isCorrect = JSON.stringify(selectedChoices.sort()) === JSON.stringify(currentQuestion.answer.sort());
      if (isCorrect) {
        score++;
      } else {
        // Ajouter aux questions rat√©es
        if (!missedQuestions.find(q => q.id === currentQuestion.id)) {
          missedQuestions.push(currentQuestion);
          localStorage.setItem('dwwm_missed_questions', JSON.stringify(missedQuestions));
        }
      }
      
      // Afficher le feedback visuel
      document.querySelectorAll('.choice').forEach((choice, i) => {
        const isCorrectAnswer = currentQuestion.answer.includes(i);
        const isSelected = selectedChoices.includes(i);
        
        choice.style.pointerEvents = 'none';
        
        if (isCorrectAnswer) {
          choice.classList.add('correct');
        } else if (isSelected) {
          choice.classList.add('incorrect');
        }
      });
      
      // Afficher l'explication
      document.getElementById('explanation').classList.add('show');
      
      // Changer les boutons
      document.getElementById('submitBtn').style.display = 'none';
      document.getElementById('nextBtn').style.display = 'inline-block';
      
      updateScore();
    }

    // Question suivante (solo)
    function nextQuestion() {
      currentQuestionIndex++;
      showQuestion();
    }

    // Timer (solo uniquement)
    function startTimer() {
      // Le timer n'est utilis√© qu'en mode solo
      if (currentMode === 'host' || currentMode === 'join') {
        timerDisplay.textContent = '';
        return;
      }
      
      timer = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `‚è±Ô∏è ${timeLeft}s`;
        
        if (timeLeft <= 10) {
          timerDisplay.style.color = '#e17055';
        }
        
        if (timeLeft <= 0) {
          clearInterval(timer);
          if (!hasAnswered) {
            submitAnswer();
          }
        }
      }, 1000);
    }

    // Mise √† jour du score
    function updateScore() {
      if (isHost) {
        if (configQuizFormat === 'series') {
          const currentSeriesNum = Math.floor(currentQuestionIndex / 5) + 1;
          const totalSeries = configSeriesCount;
          scoreText.textContent = `üëë H√¥te - S√©rie ${currentSeriesNum}/${totalSeries}`;
        } else {
          scoreText.textContent = `üëë H√¥te - Question ${currentQuestionIndex + 1}/${questions.length}`;
        }
      } else {
        if (configQuizFormat === 'series') {
          const currentSeriesNum = Math.floor(currentQuestionIndex / 5) + 1;
          const questionInSeries = (currentQuestionIndex % 5) + 1;
          const totalSeries = configSeriesCount;
          scoreText.textContent = `Score: ${score} pts | S√©rie ${currentSeriesNum}/${totalSeries} (Q${questionInSeries}/5)`;
        } else {
          scoreText.textContent = `Score: ${score}/${Math.max(currentQuestionIndex, 1)} (${Math.round((score/Math.max(currentQuestionIndex, 1))*100)}%)`;
        }
      }
    }

    // Mise √† jour de la progression
    function updateProgress() {
      if (configQuizFormat === 'series') {
        const currentSeriesNum = Math.floor(currentQuestionIndex / 5) + 1;
        const questionInSeries = (currentQuestionIndex % 5) + 1;
        const progress = (questionInSeries / 5) * 100;
        progressFill.style.width = progress + '%';
      } else {
        const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
        progressFill.style.width = progress + '%';
      }
    }

    // R√©sultats finaux (solo)
    function showFinalResults() {
      clearInterval(timer);
      const endTime = Date.now();
      const duration = Math.round((endTime - startTime) / 1000);
      const percentage = Math.round((score / questions.length) * 100);
      
      let performance = '';
      let emoji = '';
      if (percentage >= 90) { performance = 'Excellent !'; emoji = 'üèÜ'; }
      else if (percentage >= 80) { performance = 'Tr√®s bien !'; emoji = 'ü•á'; }
      else if (percentage >= 70) { performance = 'Bien !'; emoji = 'ü•à'; }
      else if (percentage >= 60) { performance = 'Passable'; emoji = 'ü•â'; }
      else if (percentage >= 50) { performance = '√Ä am√©liorer'; emoji = 'üìö'; }
      else { performance = '√Ä retravailler'; emoji = 'üí™'; }
      
      const html = `
        <div class="final-results">
          <h2>${emoji} Quiz termin√© !</h2>
          
          <div class="stats-grid">
            <div class="stat-card">
              <h3>${score}/${questions.length}</h3>
              <p>Questions correctes</p>
            </div>
            <div class="stat-card">
              <h3>${percentage}%</h3>
              <p>Taux de r√©ussite</p>
            </div>
            <div class="stat-card">
              <h3>${duration}s</h3>
              <p>Temps total</p>
            </div>
            <div class="stat-card">
              <h3>${performance}</h3>
              <p>√âvaluation</p>
            </div>
          </div>
          
          ${missedQuestions.length > 0 ? `
            <div class="missed-questions">
              <h3>üìù Questions √† r√©viser</h3>
              <p>Vous avez ${missedQuestions.length} questions en attente de r√©vision.</p>
              <button class="review-btn" onclick="selectMode('review')">üîÑ R√©viser maintenant</button>
            </div>
          ` : ''}
          
          <div style="margin-top: 30px;">
            <button onclick="restart()">üîÑ Refaire ce type de quiz</button>
            <button onclick="goHome()" style="background: #6c757d;">üè† Menu principal</button>
            ${currentMode !== 'review' ? '<button onclick="clearMissedQuestions()" style="background: #dc3545;">üóëÔ∏è Vider les r√©visions</button>' : ''}
          </div>
        </div>
      `;
      
      questionContainer.innerHTML = html;
    }

    // Vider les questions rat√©es
    function clearMissedQuestions() {
      if (confirm('√ätes-vous s√ªr de vouloir supprimer toutes les questions √† r√©viser ?')) {
        missedQuestions = [];
        localStorage.removeItem('dwwm_missed_questions');
        alert('Questions de r√©vision supprim√©es !');
      }
    }

    // Red√©marrer
    function restart() {
      selectedType = '';
      if (currentMode === 'host' || currentMode === 'join') {
        goHome();
      } else {
        startQuiz();
      }
    }

    // Retour au menu
    function goHome() {
      // Nettoyer Firebase si n√©cessaire
      if (roomId) {
        database.ref('rooms/' + roomId + '/players/' + playerId).remove();
      }
      
      gameArea.style.display = 'none';
      typeSelector.style.display = 'none';
      connectionInfo.style.display = 'none';
      mainMenu.style.display = 'block';
      selectedType = '';
      currentMode = '';
      isHost = false;
      roomId = '';
      playerId = '';
      clearInterval(timer);
    }

    // M√©langer un tableau
    function shuffleArray(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // Auto-join via URL
    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const joinCode = urlParams.get('join');
      if (joinCode) {
        setTimeout(() => selectMode('join'), 500);
      }
    });
  </script>
</body>
</html>
