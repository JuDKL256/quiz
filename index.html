<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz DWWM Multijoueur</title>
  <style>
    :root { 
      --color-bg-start: #667eea; 
      --color-bg-end: #764ba2; 
      --color-primary: #74b9ff; 
      --color-success: #00b894; 
      --color-error: #e17055; 
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Segoe UI', sans-serif; 
      background: linear-gradient(135deg, var(--color-bg-start), var(--color-bg-end)); 
      min-height: 100vh; 
      padding: 20px; 
      color: white;
      text-align: center;
    }
    
    .container { 
      max-width: 800px; 
      margin: auto; 
      background: rgba(255,255,255,0.1); 
      border-radius: 20px; 
      padding: 30px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    h1 { 
      font-size: 2.5em; 
      margin-bottom: 20px; 
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .game-area {
      background: rgba(255,255,255,0.2);
      border-radius: 15px;
      padding: 25px;
      margin: 20px 0;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .question-card {
      background: rgba(255,255,255,0.9);
      color: #333;
      border-radius: 15px;
      padding: 25px;
      margin: 15px 0;
      text-align: left;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .question-title {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    
    .choice {
      display: block;
      margin: 12px 0;
      padding: 15px;
      background: #f8f9fa;
      border: 2px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .choice:hover {
      background: #e3f2fd;
      border-color: var(--color-primary);
      transform: translateX(5px);
    }
    
    .choice.selected {
      background: #bbdefb;
      border-color: var(--color-primary);
    }
    
    .choice.correct {
      background: #c8e6c9 !important;
      border-color: var(--color-success) !important;
      color: #2e7d32;
    }
    
    .choice.incorrect {
      background: #ffcdd2 !important;
      border-color: var(--color-error) !important;
      color: #c62828;
    }
    
    button {
      background: linear-gradient(135deg, var(--color-primary), #0984e3);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      margin: 10px;
      transition: transform 0.2s;
    }
    
    button:hover { transform: translateY(-3px); }
    button:disabled { 
      background: #999; 
      cursor: not-allowed; 
      transform: none; 
    }
    
    .score-display {
      font-size: 1.2em;
      margin: 20px 0;
      padding: 15px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
    }
    
    .player-list {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    
    .player-card {
      background: rgba(255,255,255,0.2);
      padding: 15px;
      border-radius: 10px;
      margin: 5px;
      min-width: 120px;
    }
    
    .connection-info {
      background: rgba(255,255,255,0.15);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      font-size: 0.9em;
    }
    
    .final-results {
      background: linear-gradient(135deg, #ff9a9e, #fad0c4);
      color: #333;
      border-radius: 15px;
      padding: 30px;
      margin: 20px 0;
    }
    
    .medal {
      font-size: 2em;
      margin: 0 10px;
    }
    
    #netplay-canvas {
      display: none;
    }
    
    .intro-text {
      font-size: 1.1em;
      line-height: 1.6;
      margin: 20px 0;
      opacity: 0.9;
    }
    
    .feature-list {
      text-align: left;
      display: inline-block;
      margin: 20px 0;
    }
    
    .feature-list li {
      margin: 8px 0;
      padding-left: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ Quiz DWWM Multijoueur</h1>
    
    <div class="intro-text">
      <strong>üöÄ Multijoueur P2P - PC H√¥te + T√©l√©phones</strong><br>
      Connexion directe entre appareils, pas de serveur requis !
    </div>
    
    <div class="feature-list">
      <ul>
        <li>‚úÖ <strong>Juste une page HTML</strong> - Aucune configuration</li>
        <li>üñ•Ô∏è <strong>PC h√¥te</strong> - Contr√¥le le quiz</li>
        <li>üì± <strong>Mobiles joueurs</strong> - Rejoignent facilement</li>
        <li>‚ö° <strong>Temps r√©el</strong> - Synchronisation automatique</li>
        <li>üåê <strong>Marche partout</strong> - Pas de probl√®me r√©seau</li>
      </ul>
    </div>
    
    <!-- NetplayJS Canvas (cach√©) -->
    <canvas id="netplay-canvas" width="1" height="1"></canvas>
    
    <!-- Zone de jeu -->
    <div class="game-area" id="gameArea">
      <h2>üéÆ D√©marrage du Quiz</h2>
      <p>Initialisation de la connexion P2P...</p>
      <div class="connection-info" id="connectionInfo">
        <div>üì° Connexion NetplayJS en cours...</div>
      </div>
    </div>
    
    <!-- Affichage des joueurs -->
    <div class="player-list" id="playerList" style="display:none;">
      <div class="player-card">
        <div>üëë H√¥te</div>
        <div id="hostScore">0 pts</div>
      </div>
    </div>
    
    <!-- Affichage du score -->
    <div class="score-display" id="scoreDisplay" style="display:none;">
      Question 1/5 - Score: 0
    </div>
  </div>

  <!-- NetplayJS from CDN -->
  <script src="https://unpkg.com/netplayjs@0.4.1/dist/netplay.js" 
          integrity="sha384-6Yb8LWAT488jwK+nIjvD4S5/poq1Xn69NYjH1RXKHoaUOaFJrKQ1rfGQgKm8oQjX" 
          crossorigin="anonymous"></script>

  <script>
    // Questions DWWM
    const questionsBySubject = [
      {
        title: "Quel langage est principalement utilis√© pour le d√©veloppement web c√¥t√© client ?",
        choices: ["PHP", "JavaScript", "Python", "Java"],
        answer: [1]
      },
      {
        title: "Quels sont les piliers du d√©veloppement web moderne ?",
        choices: ["HTML", "CSS", "JavaScript", "Flash"],
        answer: [0, 1, 2]
      },
      {
        title: "Que signifie CSS ?",
        choices: ["Computer Style Sheets", "Cascading Style Sheets", "Creative Style Sheets", "Colorful Style Sheets"],
        answer: [1]
      },
      {
        title: "Quels frameworks JavaScript sont populaires ?",
        choices: ["React", "Vue.js", "Angular", "jQuery"],
        answer: [0, 1, 2]
      },
      {
        title: "Quel protocole est utilis√© pour les communications web s√©curis√©es ?",
        choices: ["HTTP", "HTTPS", "FTP", "SSH"],
        answer: [1]
      }
    ];

    // Classe Quiz NetplayJS
    class QuizGame extends netplayjs.Game {
      static timestep = 1000 / 2; // 2 FPS (suffisant pour un quiz)
      static canvasSize = { width: 1, height: 1 }; // Canvas minimal
      
      static playerInputBuilder = () => {
        return {};
      };

      constructor(canvas) {
        super(canvas);
        
        // √âtat du jeu
        this.gameState = 'lobby'; // lobby, playing, finished
        this.currentQuestionIndex = 0;
        this.questions = this.shuffleArray([...questionsBySubject]);
        this.playerAnswers = new Map();
        this.playerScores = new Map();
        this.timeLeft = 30;
        this.questionStartTime = 0;
        
        // UI Elements
        this.gameArea = document.getElementById('gameArea');
        this.playerList = document.getElementById('playerList');
        this.scoreDisplay = document.getElementById('scoreDisplay');
        this.connectionInfo = document.getElementById('connectionInfo');
        
        // Initialize UI
        this.updateUI();
      }

      // Initialiser l'√©tat du jeu
      initialize() {
        return {
          gameState: 'lobby',
          currentQuestionIndex: 0,
          questions: this.shuffleArray([...questionsBySubject]),
          playerAnswers: {},
          playerScores: {},
          timeLeft: 30,
          questionStartTime: 0,
          playerCount: 0
        };
      }

      // Mise √† jour du jeu
      update(state, inputs) {
        // Auto-start quand des joueurs rejoignent
        if (state.gameState === 'lobby' && Object.keys(inputs).length > 0) {
          state.gameState = 'playing';
          state.questionStartTime = Date.now();
          this.updateUI();
        }
        
        // Gestion du timer
        if (state.gameState === 'playing') {
          const elapsed = (Date.now() - state.questionStartTime) / 1000;
          state.timeLeft = Math.max(0, 30 - elapsed);
          
          // Question suivante automatiquement apr√®s 30s
          if (state.timeLeft <= 0) {
            this.nextQuestion(state);
          }
        }
        
        // Mise √† jour du compteur de joueurs
        state.playerCount = Object.keys(inputs).length;
        
        return state;
      }

      // Prochaine question
      nextQuestion(state) {
        state.currentQuestionIndex++;
        
        if (state.currentQuestionIndex >= state.questions.length) {
          state.gameState = 'finished';
          this.showFinalResults(state);
        } else {
          state.questionStartTime = Date.now();
          state.timeLeft = 30;
          state.playerAnswers = {};
          this.showQuestion(state);
        }
      }

      // Affichage de la question
      showQuestion(state) {
        const question = state.questions[state.currentQuestionIndex];
        if (!question) return;

        const isHost = this.getPlayers().length > 0 && this.getPlayers()[0].id === this.getMyPlayer().id;
        
        let html = `
          <div class="question-card">
            <div class="question-title">
              Question ${state.currentQuestionIndex + 1}/${state.questions.length}: ${question.title}
            </div>
        `;
        
        if (isHost) {
          // Vue h√¥te - montre les r√©ponses correctes
          html += '<div style="margin: 15px 0; font-weight: bold; color: #2c3e50;">R√©ponses correctes :</div>';
          question.choices.forEach((choice, i) => {
            const isCorrect = question.answer.includes(i);
            html += `
              <div class="choice ${isCorrect ? 'correct' : ''}" style="cursor: default;">
                ${isCorrect ? '‚úÖ' : '‚óØ'} ${choice}
              </div>
            `;
          });
          html += `<div style="margin-top: 20px; color: #666;">Les joueurs r√©pondent... ‚è±Ô∏è ${Math.ceil(state.timeLeft)}s</div>`;
        } else {
          // Vue joueur - peut r√©pondre
          question.choices.forEach((choice, i) => {
            html += `
              <div class="choice" onclick="selectChoice(${i})" data-choice="${i}">
                ${choice}
              </div>
            `;
          });
          html += '<button onclick="submitAnswer()" id="submitBtn">üìù Valider ma r√©ponse</button>';
        }
        
        html += '</div>';
        this.gameArea.innerHTML = html;
        
        // Afficher le score
        this.scoreDisplay.style.display = 'block';
        this.scoreDisplay.textContent = `Question ${state.currentQuestionIndex + 1}/${state.questions.length} - ‚è±Ô∏è ${Math.ceil(state.timeLeft)}s`;
      }

      // R√©sultats finaux
      showFinalResults(state) {
        const players = this.getPlayers();
        const results = players.map(p => ({
          name: p.id.substring(0, 8),
          score: state.playerScores[p.id] || 0
        })).sort((a, b) => b.score - a.score);

        let html = '<div class="final-results"><h2>üèÜ R√©sultats Final</h2>';
        
        results.forEach((player, index) => {
          const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0; padding: 10px; background: rgba(255,255,255,0.3); border-radius: 10px;">
              <span>${medal} ${player.name}</span>
              <span style="font-weight: bold; font-size: 1.2em;">${player.score}/${state.questions.length}</span>
            </div>
          `;
        });
        
        html += '<button onclick="restartGame()">üîÑ Nouveau Quiz</button></div>';
        this.gameArea.innerHTML = html;
      }

      // Mise √† jour de l'UI
      updateUI() {
        // Afficher les informations de connexion
        const players = this.getPlayers();
        const myPlayer = this.getMyPlayer();
        
        if (players.length === 0) {
          this.connectionInfo.innerHTML = 'üì° Connexion en cours...';
          return;
        }
        
        const isHost = players[0].id === myPlayer.id;
        
        if (isHost) {
          this.connectionInfo.innerHTML = `
            <div>üëë <strong>Vous √™tes l'h√¥te</strong></div>
            <div>üë• ${players.length} joueur(s) connect√©(s)</div>
            <div>üéØ Le quiz d√©marre automatiquement</div>
          `;
        } else {
          this.connectionInfo.innerHTML = `
            <div>üì± <strong>Vous √™tes un joueur</strong></div>
            <div>üéÆ Connect√© √† la partie</div>
            <div>‚è≥ En attente du d√©marrage...</div>
          `;
        }
        
        // Afficher la liste des joueurs
        if (players.length > 1) {
          this.playerList.style.display = 'flex';
          this.playerList.innerHTML = players.map((player, index) => {
            const isMe = player.id === myPlayer.id;
            const role = index === 0 ? 'üëë H√¥te' : 'üì± Joueur';
            return `
              <div class="player-card ${isMe ? 'style="border: 2px solid #FFD700;"' : ''}">
                <div>${role}${isMe ? ' (Vous)' : ''}</div>
                <div>${player.id.substring(0, 8)}</div>
              </div>
            `;
          }).join('');
        }
      }

      // Rendu (minimal pour NetplayJS)
      draw(state) {
        // Le rendu se fait via le DOM, pas le canvas
        this.updateUI();
      }

      // S√©rialisation de l'√©tat
      serialize(state) {
        return JSON.stringify(state);
      }

      // D√©s√©rialisation de l'√©tat
      deserialize(data) {
        return JSON.parse(data);
      }

      // Utilitaire pour m√©langer un tableau
      shuffleArray(array) {
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }
    }

    // Variables globales pour l'interaction
    let selectedChoices = [];
    let game;

    // S√©lection d'une r√©ponse
    function selectChoice(choiceIndex) {
      const choices = document.querySelectorAll('.choice');
      const choice = choices[choiceIndex];
      
      if (choice.classList.contains('selected')) {
        choice.classList.remove('selected');
        selectedChoices = selectedChoices.filter(i => i !== choiceIndex);
      } else {
        choice.classList.add('selected');
        selectedChoices.push(choiceIndex);
      }
    }

    // Soumettre la r√©ponse
    function submitAnswer() {
      if (selectedChoices.length === 0) {
        alert('Veuillez s√©lectionner au moins une r√©ponse !');
        return;
      }
      
      // D√©sactiver les choix
      document.querySelectorAll('.choice').forEach(choice => {
        choice.style.pointerEvents = 'none';
      });
      
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('submitBtn').textContent = '‚úÖ R√©pondu !';
      
      // Afficher le feedback visuel
      const state = game.getState();
      const currentQuestion = state.questions[state.currentQuestionIndex];
      
      document.querySelectorAll('.choice').forEach((choice, i) => {
        const isCorrect = currentQuestion.answer.includes(i);
        const isSelected = selectedChoices.includes(i);
        
        if (isCorrect) {
          choice.classList.add('correct');
        } else if (isSelected) {
          choice.classList.add('incorrect');
        }
      });
      
      // Calculer le score
      const isCorrect = JSON.stringify(selectedChoices.sort()) === JSON.stringify(currentQuestion.answer.sort());
      
      // Reset pour la prochaine question
      selectedChoices = [];
    }

    // Red√©marrer le jeu
    function restartGame() {
      if (game) {
        game.start();
      }
    }

    // D√©marrage du jeu NetplayJS
    window.addEventListener('load', () => {
      const canvas = document.getElementById('netplay-canvas');
      game = new QuizGame(canvas);
      
      try {
        game.start().then(() => {
          console.log('‚úÖ Quiz NetplayJS d√©marr√© !');
        }).catch(error => {
          console.error('‚ùå Erreur NetplayJS:', error);
          document.getElementById('gameArea').innerHTML = `
            <div style="color: #ff6b6b; text-align: center;">
              <h3>‚ùå Erreur de connexion P2P</h3>
              <p>Le mode multijoueur n'est pas disponible.</p>
              <p><strong>Solutions :</strong></p>
              <ul style="text-align: left; margin: 20px 0;">
                <li>‚Ä¢ V√©rifiez que vous √™tes sur <strong>HTTPS</strong></li>
                <li>‚Ä¢ Autorisez WebRTC dans votre navigateur</li>
                <li>‚Ä¢ Essayez avec un autre navigateur</li>
                <li>‚Ä¢ Utilisez le mode Solo √† la place</li>
              </ul>
              <button onclick="location.reload()">üîÑ R√©essayer</button>
            </div>
          `;
        });
      } catch (error) {
        console.error('‚ùå NetplayJS non support√©:', error);
        document.getElementById('gameArea').innerHTML = `
          <div style="color: #ff6b6b;">
            <h3>‚ùå WebRTC non support√©</h3>
            <p>Votre navigateur ne supporte pas les connexions P2P.</p>
            <p>Essayez avec Chrome, Firefox ou Safari r√©cent.</p>
          </div>
        `;
      }
    });
  </script>
</body>
</html>
